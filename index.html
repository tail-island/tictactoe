<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>関数型プログラミングのすゝめ</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <style type="text/css">@font-face {
font-family: octicons-link;
src: url(data:font/woff;charset=utf-8;base64,d09GRgABAAAAAAZwABAAAAAACFQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABEU0lHAAAGaAAAAAgAAAAIAAAAAUdTVUIAAAZcAAAACgAAAAoAAQAAT1MvMgAAAyQAAABJAAAAYFYEU3RjbWFwAAADcAAAAEUAAACAAJThvmN2dCAAAATkAAAABAAAAAQAAAAAZnBnbQAAA7gAAACyAAABCUM+8IhnYXNwAAAGTAAAABAAAAAQABoAI2dseWYAAAFsAAABPAAAAZwcEq9taGVhZAAAAsgAAAA0AAAANgh4a91oaGVhAAADCAAAABoAAAAkCA8DRGhtdHgAAAL8AAAADAAAAAwGAACfbG9jYQAAAsAAAAAIAAAACABiATBtYXhwAAACqAAAABgAAAAgAA8ASm5hbWUAAAToAAABQgAAAlXu73sOcG9zdAAABiwAAAAeAAAAME3QpOBwcmVwAAAEbAAAAHYAAAB/aFGpk3jaTY6xa8JAGMW/O62BDi0tJLYQincXEypYIiGJjSgHniQ6umTsUEyLm5BV6NDBP8Tpts6F0v+k/0an2i+itHDw3v2+9+DBKTzsJNnWJNTgHEy4BgG3EMI9DCEDOGEXzDADU5hBKMIgNPZqoD3SilVaXZCER3/I7AtxEJLtzzuZfI+VVkprxTlXShWKb3TBecG11rwoNlmmn1P2WYcJczl32etSpKnziC7lQyWe1smVPy/Lt7Kc+0vWY/gAgIIEqAN9we0pwKXreiMasxvabDQMM4riO+qxM2ogwDGOZTXxwxDiycQIcoYFBLj5K3EIaSctAq2kTYiw+ymhce7vwM9jSqO8JyVd5RH9gyTt2+J/yUmYlIR0s04n6+7Vm1ozezUeLEaUjhaDSuXHwVRgvLJn1tQ7xiuVv/ocTRF42mNgZGBgYGbwZOBiAAFGJBIMAAizAFoAAABiAGIAznjaY2BkYGAA4in8zwXi+W2+MjCzMIDApSwvXzC97Z4Ig8N/BxYGZgcgl52BCSQKAA3jCV8CAABfAAAAAAQAAEB42mNgZGBg4f3vACQZQABIMjKgAmYAKEgBXgAAeNpjYGY6wTiBgZWBg2kmUxoDA4MPhGZMYzBi1AHygVLYQUCaawqDA4PChxhmh/8ODDEsvAwHgMKMIDnGL0x7gJQCAwMAJd4MFwAAAHjaY2BgYGaA4DAGRgYQkAHyGMF8NgYrIM3JIAGVYYDT+AEjAwuDFpBmA9KMDEwMCh9i/v8H8sH0/4dQc1iAmAkALaUKLgAAAHjaTY9LDsIgEIbtgqHUPpDi3gPoBVyRTmTddOmqTXThEXqrob2gQ1FjwpDvfwCBdmdXC5AVKFu3e5MfNFJ29KTQT48Ob9/lqYwOGZxeUelN2U2R6+cArgtCJpauW7UQBqnFkUsjAY/kOU1cP+DAgvxwn1chZDwUbd6CFimGXwzwF6tPbFIcjEl+vvmM/byA48e6tWrKArm4ZJlCbdsrxksL1AwWn/yBSJKpYbq8AXaaTb8AAHja28jAwOC00ZrBeQNDQOWO//sdBBgYGRiYWYAEELEwMTE4uzo5Zzo5b2BxdnFOcALxNjA6b2ByTswC8jYwg0VlNuoCTWAMqNzMzsoK1rEhNqByEyerg5PMJlYuVueETKcd/89uBpnpvIEVomeHLoMsAAe1Id4AAAAAAAB42oWQT07CQBTGv0JBhagk7HQzKxca2sJCE1hDt4QF+9JOS0nbaaYDCQfwCJ7Au3AHj+LO13FMmm6cl7785vven0kBjHCBhfpYuNa5Ph1c0e2Xu3jEvWG7UdPDLZ4N92nOm+EBXuAbHmIMSRMs+4aUEd4Nd3CHD8NdvOLTsA2GL8M9PODbcL+hD7C1xoaHeLJSEao0FEW14ckxC+TU8TxvsY6X0eLPmRhry2WVioLpkrbp84LLQPGI7c6sOiUzpWIWS5GzlSgUzzLBSikOPFTOXqly7rqx0Z1Q5BAIoZBSFihQYQOOBEdkCOgXTOHA07HAGjGWiIjaPZNW13/+lm6S9FT7rLHFJ6fQbkATOG1j2OFMucKJJsxIVfQORl+9Jyda6Sl1dUYhSCm1dyClfoeDve4qMYdLEbfqHf3O/AdDumsjAAB42mNgYoAAZQYjBmyAGYQZmdhL8zLdDEydARfoAqIAAAABAAMABwAKABMAB///AA8AAQAAAAAAAAAAAAAAAAABAAAAAA==) format('woff');
}

.markdown-body {
-webkit-text-size-adjust: 100%;
box-sizing: border-box;
color: #333;
font-family: "Hiragino Mincho ProN", TakaoExMincho, Meiryo, serif;
font-size: 16px;
line-height: 1.6;
margin: 0 auto;
max-width: 980px;
min-width: 200px;
text-size-adjust: 100%;
word-wrap: break-word;
}
.markdown-body a {
background-color: transparent;
}
.markdown-body a:active,
.markdown-body a:hover {
outline: 0;
}
.markdown-body strong {
font-weight: bold;
}
.markdown-body h1 {
font-size: 2em;
margin: 0.67em 0;
}
.markdown-body img {
border: 0;
}
.markdown-body hr {
box-sizing: content-box;
height: 0;
}
.markdown-body pre {
overflow: auto;
}
.markdown-body code,
.markdown-body kbd,
.markdown-body pre {
font-family: monospace, monospace;
font-size: 1em;
}
.markdown-body input {
color: inherit;
font: inherit;
margin: 0;
}
.markdown-body html input[disabled] {
cursor: default;
}
.markdown-body input {
line-height: normal;
}
.markdown-body input[type="checkbox"] {
box-sizing: border-box;
padding: 0;
}
.markdown-body table {
border-collapse: collapse;
border-spacing: 0;
}
.markdown-body td,
.markdown-body th {
padding: 0;
}
.markdown-body * {
box-sizing: border-box;
}
.markdown-body input {
font: 13px / 1.4 Helvetica, arial, nimbussansl, liberationsans, freesans, clean, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
}
.markdown-body a {
color: #4078c0;
text-decoration: none;
}
.markdown-body a:hover,
.markdown-body a:active {
text-decoration: underline;
}
.markdown-body hr {
height: 0;
margin: 15px 0;
overflow: hidden;
background: transparent;
border: 0;
border-bottom: 1px solid #ddd;
}
.markdown-body hr:before {
display: table;
content: "";
}
.markdown-body hr:after {
display: table;
clear: both;
content: "";
}
.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
margin-top: 15px;
margin-bottom: 15px;
line-height: 1.1;
}
.markdown-body h1 {
font-size: 30px;
}
.markdown-body h2 {
font-size: 21px;
}
.markdown-body h3 {
font-size: 16px;
}
.markdown-body h4 {
font-size: 14px;
}
.markdown-body h5 {
font-size: 12px;
}
.markdown-body h6 {
font-size: 11px;
}
.markdown-body blockquote {
margin: 0;
}
.markdown-body ul,
.markdown-body ol {
padding: 0;
margin-top: 0;
margin-bottom: 0;
}
.markdown-body ol ol,
.markdown-body ul ol {
list-style-type: lower-roman;
}
.markdown-body ul ul ol,
.markdown-body ul ol ol,
.markdown-body ol ul ol,
.markdown-body ol ol ol {
list-style-type: lower-alpha;
}
.markdown-body dd {
margin-left: 0;
}
.markdown-body code {
font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
font-size: 12px;
}
.markdown-body pre {
margin-top: 0;
margin-bottom: 0;
font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}
.markdown-body .select::-ms-expand {
opacity: 0;
}
.markdown-body .octicon {
font: normal normal normal 16px/1 octicons-link;
display: inline-block;
text-decoration: none;
text-rendering: auto;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
-webkit-user-select: none;
-moz-user-select: none;
-ms-user-select: none;
user-select: none;
}
.markdown-body .octicon-link:before {
content: '\f05c';
}
.markdown-body:before {
display: table;
content: "";
}
.markdown-body:after {
display: table;
clear: both;
content: "";
}
.markdown-body>*:first-child {
margin-top: 0 !important;
}
.markdown-body>*:last-child {
margin-bottom: 0 !important;
}
.markdown-body a:not([href]) {
color: inherit;
text-decoration: none;
}
.markdown-body .anchor {
display: inline-block;
padding-right: 2px;
margin-left: -18px;
}
.markdown-body .anchor:focus {
outline: none;
}
.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
margin-top: 1em;
margin-bottom: 16px;
font-weight: bold;
line-height: 1.4;
}
.markdown-body h1 .octicon-link,
.markdown-body h2 .octicon-link,
.markdown-body h3 .octicon-link,
.markdown-body h4 .octicon-link,
.markdown-body h5 .octicon-link,
.markdown-body h6 .octicon-link {
color: #000;
vertical-align: middle;
visibility: hidden;
}
.markdown-body h1:hover .anchor,
.markdown-body h2:hover .anchor,
.markdown-body h3:hover .anchor,
.markdown-body h4:hover .anchor,
.markdown-body h5:hover .anchor,
.markdown-body h6:hover .anchor {
text-decoration: none;
}
.markdown-body h1:hover .anchor .octicon-link,
.markdown-body h2:hover .anchor .octicon-link,
.markdown-body h3:hover .anchor .octicon-link,
.markdown-body h4:hover .anchor .octicon-link,
.markdown-body h5:hover .anchor .octicon-link,
.markdown-body h6:hover .anchor .octicon-link {
visibility: visible;
}
.markdown-body h1 {
padding-bottom: 0.3em;
font-size: 2.25em;
line-height: 1.2;
border-bottom: 1px solid #eee;
}
.markdown-body h1 .anchor {
line-height: 1;
}
.markdown-body h2 {
padding-bottom: 0.3em;
font-size: 1.75em;
line-height: 1.225;
border-bottom: 1px solid #eee;
}
.markdown-body h2 .anchor {
line-height: 1;
}
.markdown-body h3 {
font-size: 1.5em;
line-height: 1.43;
}
.markdown-body h3 .anchor {
line-height: 1.2;
}
.markdown-body h4 {
font-size: 1.25em;
}
.markdown-body h4 .anchor {
line-height: 1.2;
}
.markdown-body h5 {
font-size: 1em;
}
.markdown-body h5 .anchor {
line-height: 1.1;
}
.markdown-body h6 {
font-size: 1em;
color: #777;
}
.markdown-body h6 .anchor {
line-height: 1.1;
}
.markdown-body p,
.markdown-body blockquote,
.markdown-body ul,
.markdown-body ol,
.markdown-body dl,
.markdown-body table,
.markdown-body pre {
margin-top: 0;
margin-bottom: 16px;
}
.markdown-body hr {
height: 4px;
padding: 0;
margin: 16px 0;
background-color: #e7e7e7;
border: 0 none;
}
.markdown-body ul,
.markdown-body ol {
padding-left: 2em;
}
.markdown-body ul ul,
.markdown-body ul ol,
.markdown-body ol ol,
.markdown-body ol ul {
margin-top: 0;
margin-bottom: 0;
}
.markdown-body li>p {
margin-top: 16px;
}
.markdown-body dl {
padding: 0;
}
.markdown-body dl dt {
padding: 0;
margin-top: 16px;
font-size: 1em;
font-style: italic;
font-weight: bold;
}
.markdown-body dl dd {
padding: 0 16px;
margin-bottom: 16px;
}
.markdown-body blockquote {
padding: 0 15px;
color: #777;
border-left: 4px solid #ddd;
}
.markdown-body blockquote>:first-child {
margin-top: 0;
}
.markdown-body blockquote>:last-child {
margin-bottom: 0;
}
.markdown-body table {
display: block;
width: 100%;
overflow: auto;
word-break: normal;
word-break: keep-all;
}
.markdown-body table th {
font-weight: bold;
}
.markdown-body table th,
.markdown-body table td {
padding: 6px 13px;
border: 1px solid #ddd;
}
.markdown-body table tr {
background-color: #fff;
border-top: 1px solid #ccc;
}
.markdown-body table tr:nth-child(2n) {
background-color: #f8f8f8;
}
.markdown-body img {
max-width: 100%;
box-sizing: content-box;
background-color: #fff;
}
.markdown-body code {
padding: 0;
padding-top: 0.2em;
padding-bottom: 0.2em;
margin: 0;
font-size: 85%;
background-color: rgba(0,0,0,0.04);
border-radius: 3px;
}
.markdown-body code:before,
.markdown-body code:after {
letter-spacing: -0.2em;
content: "\00a0";
}
.markdown-body pre>code {
padding: 0;
margin: 0;
font-size: 100%;
word-break: normal;
white-space: pre;
background: transparent;
border: 0;
}
.markdown-body .highlight {
margin-bottom: 16px;
}
.markdown-body .highlight pre,
.markdown-body pre {
padding: 16px;
overflow: auto;
font-size: 85%;
line-height: 1.45;
background-color: #f7f7f7;
border-radius: 3px;
}
.markdown-body .highlight pre {
margin-bottom: 0;
word-break: normal;
}
.markdown-body pre {
word-wrap: normal;
}
.markdown-body pre code {
display: inline;
max-width: initial;
padding: 0;
margin: 0;
overflow: initial;
line-height: inherit;
word-wrap: normal;
background-color: transparent;
border: 0;
}
.markdown-body pre code:before,
.markdown-body pre code:after {
content: normal;
}
.markdown-body kbd {
display: inline-block;
padding: 3px 5px;
font-size: 11px;
line-height: 10px;
color: #555;
vertical-align: middle;
background-color: #fcfcfc;
border: solid 1px #ccc;
border-bottom-color: #bbb;
border-radius: 3px;
box-shadow: inset 0 -1px 0 #bbb;
}
.markdown-body .pl-c {
color: #969896;
}
.markdown-body .pl-c1,
.markdown-body .pl-s .pl-v {
color: #0086b3;
}
.markdown-body .pl-e,
.markdown-body .pl-en {
color: #795da3;
}
.markdown-body .pl-s .pl-s1,
.markdown-body .pl-smi {
color: #333;
}
.markdown-body .pl-ent {
color: #63a35c;
}
.markdown-body .pl-k {
color: #a71d5d;
}
.markdown-body .pl-pds,
.markdown-body .pl-s,
.markdown-body .pl-s .pl-pse .pl-s1,
.markdown-body .pl-sr,
.markdown-body .pl-sr .pl-cce,
.markdown-body .pl-sr .pl-sra,
.markdown-body .pl-sr .pl-sre {
color: #183691;
}
.markdown-body .pl-v {
color: #ed6a43;
}
.markdown-body .pl-id {
color: #b52a1d;
}
.markdown-body .pl-ii {
background-color: #b52a1d;
color: #f8f8f8;
}
.markdown-body .pl-sr .pl-cce {
color: #63a35c;
font-weight: bold;
}
.markdown-body .pl-ml {
color: #693a17;
}
.markdown-body .pl-mh,
.markdown-body .pl-mh .pl-en,
.markdown-body .pl-ms {
color: #1d3e81;
font-weight: bold;
}
.markdown-body .pl-mq {
color: #008080;
}
.markdown-body .pl-mi {
color: #333;
font-style: italic;
}
.markdown-body .pl-mb {
color: #333;
font-weight: bold;
}
.markdown-body .pl-md {
background-color: #ffecec;
color: #bd2c00;
}
.markdown-body .pl-mi1 {
background-color: #eaffea;
color: #55a532;
}
.markdown-body .pl-mdr {
color: #795da3;
font-weight: bold;
}
.markdown-body .pl-mo {
color: #1d3e81;
}
.markdown-body kbd {
display: inline-block;
padding: 3px 5px;
font: 11px Consolas, "Liberation Mono", Menlo, Courier, monospace;
line-height: 10px;
color: #555;
vertical-align: middle;
background-color: #fcfcfc;
border: solid 1px #ccc;
border-bottom-color: #bbb;
border-radius: 3px;
box-shadow: inset 0 -1px 0 #bbb;
}
.markdown-body .task-list-item {
list-style-type: none;
}
.markdown-body .task-list-item+.task-list-item {
margin-top: 3px;
}
.markdown-body .task-list-item input {
margin: 0 0.35em 0.25em -1.6em;
vertical-align: middle;
}
.markdown-body :checked+.radio-label {
z-index: 1;
position: relative;
border-color: #4078c0;
}
</style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <meta name="title" content="深層学習プログラミング・ガイド">
  <meta name="description" content="深層学習の、多分最も簡単じゃないかなーと思うプログラミング・ガイド。">
  <meta name="keywords" content="ディープラーニング, Deep Learning">
</head>
<body>
<article class="markdown-body">
<h1>関数型プログラミングのすゝめ</h1>
<p>突然ですが、質問です。関数の引数が参照渡しになるプログラミング言語と値渡しになるプログラミング言語、あなたはどちらが好きですか？</p>
<p>プリミティブ型だと値渡しでオブジェクト型だと参照渡しになるというような意味での質問ではなくて、古き良きFORTRANのような参照渡ししか存在しないプログラミング言語と値渡しがサポートされている今時のプログラミング言語の、どちらが好きかという質問です。</p>
<p>当然、値渡しをサポートするプログラミング言語の方が好きですよね？　<code>foo(x)</code>と書く場合に、<code>x</code>の内容が関数の呼び出し前と後で変わるかもしれないと考えながらプログラミングするのは大変ですもん。副作用が少ない方が、楽にプログラミングできるというわけ。</p>
<p>この副作用を考えなくても良いプログラミングの方式があったら、嬉しいと思いませんか？　関数型プログラミングは、この面倒な副作用を究極まで抑えてくれるんです。</p>
<hr />
<p>もう一つ質問を。コピー＆ペーストして新しいコードを作成したことがありますか？　コード途中の一部分が異なるのだけど、その部分はコピー＆ペーストした上で修正せざるをえなかったという場合です。</p>
<p>私は昔、大量にコピー＆ペーストしてコードを作成していました。forループの中の条件式がちょっと違うんだよなぁ、とか、<code>x</code>には<code>width</code>で<code>y</code>には<code>height</code>で処理しなければならないんだよなぁ、とかという場合です。重複が発生して嫌な臭いが漂ってくるんですけど、でもこれはどうにもならないんだと諦めていました。</p>
<p>もしこの重複をゼロにできるなら、嬉しいと思いませんか？　関数という小さな要素を組み合わせて関数を作成していく関数型プログラミングは、この重複を極限まで減らしてくれるんです。</p>
<hr />
<p>もし上の提案を魅力的だと思ったなら、お暇な時に本稿を読んでみてください。使用するプログラミング言語は多くの方に馴染みがあるだろうJavaScript（実行環境はNode.js。文法はECMAScript 2017）なので、ご安心を。Haskellのような関数型プログラミング言語を使用しなくても、今時の言語ならかなりのところまで関数型プログラミングできるんです。たぶん、あなたが次のプロジェクトで使おうとしている、そのプログラミング言語でも。</p>
<h2>副作用は悪。被害を減らすために、昔から様々な工夫がなされてきました</h2>
<p>大昔、私が初めてコンピューターに触ったころ、マイコン（マイクロ・コンピューター）からパソコン（パーソナル・コンピューター）に名前が変わり始めたころは、プログラミングはBASICという言語でやるものでした。このBASICって、今考えると信じられないのですけど、グローバル変数しかなかったんですよ。サブ・ルーチンで何か計算をしたら、その計算結果はグローバル変数に入れるしかなくて、だから、どのサブ・ルーチンがどの変数を変更するのかの対応表を頭の中においてプログラミングしていました。</p>
<p>実は、近代プログラミング言語であるJavaScriptでも、<code>var</code>や<code>const</code>や<code>let</code>で修飾しなければ、グローバルな変数になってしまうんです<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="op">&lt;!</span>DOCTYPE html<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="op">&lt;</span>html<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">  <span class="op">&lt;</span>head<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">    <span class="op">&lt;</span>title<span class="op">&gt;</span>Pythonを書いた後だとやりがちなミス&lt;/title<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5">  &lt;/head<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6">  <span class="op">&lt;</span>body<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7">    <span class="op">&lt;</span>script<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8">      <span class="kw">function</span> <span class="at">foo</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9">        i <span class="op">=</span> <span class="dv">999</span><span class="op">;</span>  <span class="co">// iはグローバル変数。</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10">      <span class="op">}</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11"></a>
<a class="sourceLine" id="cb1-12" data-line-number="12">      <span class="cf">for</span> (i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> <span class="op">++</span>i) <span class="op">{</span>  <span class="co">// iはグローバル変数。</span></a>
<a class="sourceLine" id="cb1-13" data-line-number="13">         <span class="at">foo</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb1-14" data-line-number="14"></a>
<a class="sourceLine" id="cb1-15" data-line-number="15">         <span class="va">document</span>.<span class="at">write</span>(<span class="st">''</span> <span class="op">+</span> (i <span class="op">+</span> <span class="dv">1</span>) <span class="op">+</span> <span class="st">'回fooしました&lt;br&gt;'</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-16" data-line-number="16">      <span class="op">}</span></a>
<a class="sourceLine" id="cb1-17" data-line-number="17">    &lt;/script<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb1-18" data-line-number="18">  &lt;/body<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb1-19" data-line-number="19">&lt;/html<span class="op">&gt;</span></a></code></pre></div>
<p>上のコードはグローバル変数をループのカウンターとして使用していて、そのグローバル変数のカウンターを<code>foo</code>の中で変更していますから、ループの実行回数は1回だけで、しかも「1000回fooしました」と表示されてしまいます。大昔は、こんなプログラミング言語ばっかりだったんですよ。</p>
<p>こんな状態じゃあとてもプログラムなんか書いてられないので、関数内でだけ使える変数ってのが生まれたわけです。JavaScriptの場合は、<code>var</code>を付けるとその変数のスコープ（有効範囲）は関数内のみになります（関数の外側で宣言されれば、グローバル変数ですけど）。しかし、<code>var</code>をつけていても、以下のような場合には混乱が発生しました。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">function</span> <span class="at">foo</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">  <span class="kw">var</span> x <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">  <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> <span class="op">++</span>i) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">    <span class="kw">var</span> x <span class="op">=</span> i<span class="op">;</span>  <span class="co">// このxは外側のxと同じ変数になります。</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"></a>
<a class="sourceLine" id="cb2-7" data-line-number="7">    ...</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">  <span class="op">}</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"></a>
<a class="sourceLine" id="cb2-10" data-line-number="10">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`</span><span class="sc">${</span> x <span class="sc">}</span><span class="vs"> == 9です`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="op">}</span></a></code></pre></div>
<p><code>for</code>の内側の<code>x</code>と外側の<code>x</code>のスコープは関数<code>foo</code>と同じものなので実体は同じ変数、だから最後の<code>console.log</code>では9が表示されてしまいます。この問題を避けるために、変数を<code>var</code>するときは同じ関数の中で同じ名前の変数が<code>var</code>されていないことを確認する……のは面倒ですね。</p>
<p>だから、ECMAScript 2015で<code>let</code>が追加されました。<code>let</code>のスコープはブロックなので、関数よりも小さな範囲であるブロックをチェックするだけで済んでとても嬉しい。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">function</span> <span class="at">foo</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">  <span class="kw">var</span> x <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"></a>
<a class="sourceLine" id="cb3-4" data-line-number="4">  <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> <span class="op">++</span>i) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5">    <span class="kw">let</span> x <span class="op">=</span> i<span class="op">;</span>  <span class="co">// varをletに変更。これで外側のxとは別の変数になります。</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"></a>
<a class="sourceLine" id="cb3-7" data-line-number="7">    ...</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">  <span class="op">}</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"></a>
<a class="sourceLine" id="cb3-10" data-line-number="10">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`</span><span class="sc">${</span> x <span class="sc">}</span><span class="vs"> == 0です`</span>)<span class="op">;</span>  <span class="co">// letなので、ブロック内の変更の影響を受けません</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="op">}</span></a></code></pre></div>
<p>ふぅ、これでメデタシメデタシ……なわけじゃないですよね。ブロックが大きい場合はチェックが大変ですし、<code>for</code>の中の<code>let</code>を書き忘れたら外側に悪影響が出ちゃいますし。</p>
<p>なんだか、ここまでの話って、対症療法を繰り返しただけに思えませんか？　内側が迷惑をかける可能性がある範囲を少しずつ小さくしてきただけ。迷惑を被る外側にしてみると、内側を全部チェックしなければならないので面倒極まりなくて、根本解決じゃあない。</p>
<p>そもそも、変数ってのが良くないんじゃないでしょうか？　いや、変数そのものは別に悪くないのかも。たぶん、変数の値を変更できてしまうことが悪いのでしょう。処理にともなって状態（変数の値）が変更されることを副作用と呼ぶのですけど、この副作用が、諸悪の根源なのではないでしょうか？</p>
<h2>イミュータブルでいきましょう</h2>
<p>というわけで、根本解決しちゃいましょう。ECMAScript 2015の<code>const</code>を使えば、再代入できない変数を定義できます。たとえば、以下のコードはきちんとエラーになるので安心です。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">const</span> x <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> <span class="op">++</span>i) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">  x <span class="op">=</span> i<span class="op">;</span>  <span class="co">// ここでエラーになります。再代入はできません。</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"></a>
<a class="sourceLine" id="cb4-6" data-line-number="6">  ...</a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="op">}</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="va">console</span>.<span class="at">log</span>(<span class="vs">`</span><span class="sc">${</span> x <span class="sc">}</span><span class="vs"> == 0です。途中で再代入してエラーになるかもしれませんけど`</span>)<span class="op">;</span></a></code></pre></div>
<p>でも、<code>const</code>って、再代入を防ぐだけなんですよ。だから、以下のような場合には問題が発生しちゃう。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">function</span> <span class="at">foo</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">  <span class="kw">const</span> xs <span class="op">=</span> [<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">  <span class="cf">for</span> (<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> <span class="op">++</span>i) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5">    xs[i] <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>  <span class="co">// xsへの再代入ではないので、エラーにはなりません</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"></a>
<a class="sourceLine" id="cb5-7" data-line-number="7">    ...</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">  <span class="op">}</span></a>
<a class="sourceLine" id="cb5-9" data-line-number="9"></a>
<a class="sourceLine" id="cb5-10" data-line-number="10">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`</span><span class="sc">${</span> xs <span class="sc">}</span><span class="vs"> == 0,0,0,0,0,0,0,0,0,0です`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-11" data-line-number="11"><span class="op">}</span></a></code></pre></div>
<p><code>xs = [0, 0, 0]</code>ならば再代入なのでエラーになってくれますけど、<code>xs[0] = 0</code>は<code>xs</code>そのものへの再代入ではないのでエラーになってくれないんです。</p>
<p>関数呼び出しのときにも、同じことが言えます。以下のコードなら<code>foo()</code>の中を見ないでも安心して<code>x</code>を使えますけど、</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">const</span> x <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="at">foo</span>(x)<span class="op">;</span>  <span class="co">// xはプリミティブな型なので、値渡しになります。だから、fooの中でどんな処理をしても影響されません。</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="kw">const</span> y <span class="op">=</span> x <span class="op">+</span> ...  <span class="co">// fooをチェックしないでも、安心してxを使えます。</span></a></code></pre></div>
<p>以下のコードの場合は、<code>foo()</code>の中を見ないと怖くてしょうがない。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">const</span> xs <span class="op">=</span> [<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="at">foo</span>(xs)<span class="op">;</span>  <span class="co">// xsはオブジェクト（Array）なので、参照渡しになります。だから、fooの処理次第では中身が変わってしまいます。</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="kw">const</span> y <span class="op">=</span> xs[<span class="dv">0</span>]<span class="op">;</span>  <span class="co">// yに何が代入されるかは、fooの処理内容次第……。</span></a></code></pre></div>
<p>この問題はECMAScriptの文法だけでは解決できません<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>ので、facebook社が作成してくれた最近話題の<a href="https://facebook.github.io/immutable-js/">Immutable.js</a>を使って解決しましょう。Immutable.jsを使ったコードは、以下のような感じになります。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="im">import</span> I <span class="im">from</span> <span class="st">'immutable'</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2"></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="kw">const</span> xs <span class="op">=</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="kw">const</span> ys <span class="op">=</span> <span class="va">xs</span>.<span class="at">set</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">999</span>)<span class="op">;</span>  <span class="co">// 0番目を999に変更した新しいリストを返します。</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5"></a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="va">console</span>.<span class="at">log</span>(xs)<span class="op">;</span>  <span class="co">// List [ 1, 2, 3 ]。イミュータブルなので変更されません。</span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="va">console</span>.<span class="at">log</span>(ys)<span class="op">;</span>  <span class="co">// List [ 999, 2, 3 ]。0番目の要素がきちんと999になっています。</span></a></code></pre></div>
<p>うん、これで副作用がない安心なコードを書ける……のかな？　まだ関数型プログラミングが出てきていないけど……。</p>
<h2>メソッドの中の変数もイミュータブルにしたい</h2>
<p>とりあえず、Immutable.jsを使ったオブジェクト指向なコードを考えてみましょう。お題は「絶対に負けない三目並べ」としました。コードは<a href="https://github.com/tail-island/tictactoe/">GitHub</a>にあります。</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="im">import</span> I        <span class="im">from</span> <span class="st">'immutable'</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="im">import</span> process  <span class="im">from</span> <span class="st">'process'</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="im">import</span> readline <span class="im">from</span> <span class="st">'readline'</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="co">// ゲームの状態を表すクラス。イミュータブル！</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="kw">class</span> GameState <span class="kw">extends</span> <span class="va">I</span>.<span class="at">Record</span>(<span class="op">{</span><span class="dt">board</span><span class="op">:</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">}</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7">  <span class="co">// まだマルやバツが書き込まれていないセルの数を数えます。他のメソッドの共通部分を抽出したものです。</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8">  get <span class="at">vacantCellCount</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9">    <span class="kw">let</span> vacantCellCount <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>  <span class="co">// イミュータブルじゃないけど、しょうがない……。まぁ、メソッドの中でしか使わないし。</span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10"></a>
<a class="sourceLine" id="cb9-11" data-line-number="11">    <span class="cf">for</span> (<span class="kw">const</span> cell of <span class="kw">this</span>.<span class="at">board</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12">      <span class="cf">if</span> (cell <span class="op">==</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13">        vacantCellCount<span class="op">++;</span></a>
<a class="sourceLine" id="cb9-14" data-line-number="14">      <span class="op">}</span></a>
<a class="sourceLine" id="cb9-15" data-line-number="15">    <span class="op">}</span></a>
<a class="sourceLine" id="cb9-16" data-line-number="16"></a>
<a class="sourceLine" id="cb9-17" data-line-number="17">    <span class="cf">return</span> vacantCellCount<span class="op">;</span></a>
<a class="sourceLine" id="cb9-18" data-line-number="18">  <span class="op">}</span></a>
<a class="sourceLine" id="cb9-19" data-line-number="19"></a>
<a class="sourceLine" id="cb9-20" data-line-number="20">  <span class="co">// 勝者を返します。プレイヤー1の勝ちなら1、プレイヤー2の勝ちなら2、引き分けなら0、まだ勝負がついていないなら-1を返します。勝利条件を、ここで実装します。</span></a>
<a class="sourceLine" id="cb9-21" data-line-number="21">  get <span class="at">winner</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb9-22" data-line-number="22">    <span class="co">// 縦横斜めの、一直線になるセルのインデックス。</span></a>
<a class="sourceLine" id="cb9-23" data-line-number="23">    <span class="kw">const</span> winningLines <span class="op">=</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">6</span>)<span class="op">,</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">7</span>)<span class="op">,</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">2</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">8</span>)<span class="op">,</span>  <span class="co">// 縦</span></a>
<a class="sourceLine" id="cb9-24" data-line-number="24">                                   <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">,</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span>)<span class="op">,</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">6</span><span class="op">,</span> <span class="dv">7</span><span class="op">,</span> <span class="dv">8</span>)<span class="op">,</span>  <span class="co">// 横</span></a>
<a class="sourceLine" id="cb9-25" data-line-number="25">                                   <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">8</span>)<span class="op">,</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">2</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">6</span>))<span class="op">;</span>                     <span class="co">// 斜め</span></a>
<a class="sourceLine" id="cb9-26" data-line-number="26"></a>
<a class="sourceLine" id="cb9-27" data-line-number="27">    <span class="co">// winningLinesのすべての要素に対してループ。</span></a>
<a class="sourceLine" id="cb9-28" data-line-number="28">    <span class="cf">for</span> (<span class="kw">const</span> winningLine of winningLines) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-29" data-line-number="29">      <span class="co">// プレイヤーが書き込んだマルやバツの数。プレイヤーは2人なので要素数2の配列になります。</span></a>
<a class="sourceLine" id="cb9-30" data-line-number="30">      <span class="kw">const</span> playerCellCounts <span class="op">=</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>]<span class="op">;</span>  <span class="co">// イミュータブルじゃないけど、メソッドの中でしか使わないし……。</span></a>
<a class="sourceLine" id="cb9-31" data-line-number="31"></a>
<a class="sourceLine" id="cb9-32" data-line-number="32">      <span class="co">// winningLineのすべての要素に対してループ。</span></a>
<a class="sourceLine" id="cb9-33" data-line-number="33">      <span class="cf">for</span> (<span class="kw">const</span> winningLineCell of winningLine) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-34" data-line-number="34">        <span class="co">// セルの値を取得。</span></a>
<a class="sourceLine" id="cb9-35" data-line-number="35">        <span class="kw">const</span> cell <span class="op">=</span> <span class="kw">this</span>.<span class="va">board</span>.<span class="at">get</span>(winningLineCell)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-36" data-line-number="36">        <span class="cf">if</span> (cell <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">{</span>  <span class="co">// マルカバツが書き込まれているなら、</span></a>
<a class="sourceLine" id="cb9-37" data-line-number="37">          playerCellCounts[cell <span class="op">-</span> <span class="dv">1</span>]<span class="op">++;</span>  <span class="co">// 対応するプレイヤーのマルやバツの数をインクリメント。</span></a>
<a class="sourceLine" id="cb9-38" data-line-number="38">        <span class="op">}</span></a>
<a class="sourceLine" id="cb9-39" data-line-number="39">      <span class="op">}</span></a>
<a class="sourceLine" id="cb9-40" data-line-number="40"></a>
<a class="sourceLine" id="cb9-41" data-line-number="41">      <span class="co">// もしプレイヤー1が3つ並べたなら、プレイヤー1の勝ち。</span></a>
<a class="sourceLine" id="cb9-42" data-line-number="42">      <span class="cf">if</span> (playerCellCounts[<span class="dv">0</span>] <span class="op">==</span> <span class="va">winningLine</span>.<span class="at">size</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-43" data-line-number="43">        <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-44" data-line-number="44">      <span class="op">}</span></a>
<a class="sourceLine" id="cb9-45" data-line-number="45"></a>
<a class="sourceLine" id="cb9-46" data-line-number="46">      <span class="co">// もしプレイヤー2が3つ並べたなら、プレイヤー2の勝ち。</span></a>
<a class="sourceLine" id="cb9-47" data-line-number="47">      <span class="cf">if</span> (playerCellCounts[<span class="dv">1</span>] <span class="op">==</span> <span class="va">winningLine</span>.<span class="at">size</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-48" data-line-number="48">        <span class="cf">return</span> <span class="dv">2</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-49" data-line-number="49">      <span class="op">}</span></a>
<a class="sourceLine" id="cb9-50" data-line-number="50">    <span class="op">}</span></a>
<a class="sourceLine" id="cb9-51" data-line-number="51"></a>
<a class="sourceLine" id="cb9-52" data-line-number="52">    <span class="co">// マルやバツが書き込まれていないセルの数が0なら引き分け、そうでなければまだ勝負がついていない。</span></a>
<a class="sourceLine" id="cb9-53" data-line-number="53">    <span class="cf">return</span> <span class="kw">this</span>.<span class="at">vacantCellCount</span> <span class="op">==</span> <span class="dv">0</span> <span class="op">?</span> <span class="dv">0</span> : <span class="dv">-1</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-54" data-line-number="54">  <span class="op">}</span></a>
<a class="sourceLine" id="cb9-55" data-line-number="55"></a>
<a class="sourceLine" id="cb9-56" data-line-number="56">  <span class="co">// 次のプレイヤーを取得します。</span></a>
<a class="sourceLine" id="cb9-57" data-line-number="57">  get <span class="at">nextPlayer</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb9-58" data-line-number="58">    <span class="co">// マルやバツが書き込まれていないセルの数から次のプレイヤーを判断します。</span></a>
<a class="sourceLine" id="cb9-59" data-line-number="59">    <span class="cf">return</span> <span class="kw">this</span>.<span class="at">vacantCellCount</span> <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">1</span> <span class="op">?</span> <span class="dv">1</span> : <span class="dv">2</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-60" data-line-number="60">  <span class="op">}</span></a>
<a class="sourceLine" id="cb9-61" data-line-number="61"></a>
<a class="sourceLine" id="cb9-62" data-line-number="62">  <span class="co">// 次に遷移可能なゲームの状態を返します。プレイヤーが実行可能なルールをここで実装します。</span></a>
<a class="sourceLine" id="cb9-63" data-line-number="63">  get <span class="at">nextGameStates</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb9-64" data-line-number="64">    <span class="kw">const</span> nextGameStates <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb9-65" data-line-number="65"></a>
<a class="sourceLine" id="cb9-66" data-line-number="66">    <span class="co">// すべてのボードのセルに対して……</span></a>
<a class="sourceLine" id="cb9-67" data-line-number="67">    <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="kw">this</span>.<span class="va">board</span>.<span class="at">size</span><span class="op">;</span> <span class="op">++</span>i) <span class="op">{</span>  <span class="co">// イミュータブルじゃない。for (const i of [0, 1, 2])はちょっとなぁ……。</span></a>
<a class="sourceLine" id="cb9-68" data-line-number="68">      <span class="co">// まだマルやバツが書き込まれていないなら……</span></a>
<a class="sourceLine" id="cb9-69" data-line-number="69">      <span class="cf">if</span> (<span class="kw">this</span>.<span class="va">board</span>.<span class="at">get</span>(i) <span class="op">==</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-70" data-line-number="70">        <span class="co">// 新しいゲームの状態を作成して配列に追加。setInは、指定したパスの値が変更された新しいオブジェクトを作ります。</span></a>
<a class="sourceLine" id="cb9-71" data-line-number="71">        <span class="va">nextGameStates</span>.<span class="at">push</span>(<span class="kw">this</span>.<span class="at">setIn</span>(<span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="st">'board'</span><span class="op">,</span> i)<span class="op">,</span> <span class="kw">this</span>.<span class="at">nextPlayer</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb9-72" data-line-number="72">      <span class="op">}</span></a>
<a class="sourceLine" id="cb9-73" data-line-number="73">    <span class="op">}</span></a>
<a class="sourceLine" id="cb9-74" data-line-number="74"></a>
<a class="sourceLine" id="cb9-75" data-line-number="75">    <span class="co">// 配列をイミュータブルな形に変換して返します。</span></a>
<a class="sourceLine" id="cb9-76" data-line-number="76">    <span class="cf">return</span> <span class="va">I</span>.<span class="at">List</span>(nextGameStates)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-77" data-line-number="77">  <span class="op">}</span></a>
<a class="sourceLine" id="cb9-78" data-line-number="78"></a>
<a class="sourceLine" id="cb9-79" data-line-number="79">  <span class="co">// ゲームの状態を描画します。CUIですけど……。</span></a>
<a class="sourceLine" id="cb9-80" data-line-number="80">  <span class="at">draw</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb9-81" data-line-number="81">    <span class="co">// 3行なので、とりあえずループを3回。</span></a>
<a class="sourceLine" id="cb9-82" data-line-number="82">    <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">3</span><span class="op">;</span> <span class="op">++</span>i) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-83" data-line-number="83">      <span class="co">// ゲーム板の1行分の文字列。</span></a>
<a class="sourceLine" id="cb9-84" data-line-number="84">      <span class="kw">let</span> lineString <span class="op">=</span> <span class="st">''</span><span class="op">;</span>  <span class="co">// イミュータブル……。どうにもならない……。</span></a>
<a class="sourceLine" id="cb9-85" data-line-number="85"></a>
<a class="sourceLine" id="cb9-86" data-line-number="86">      <span class="co">// 3列なので、もういちどループを3回。</span></a>
<a class="sourceLine" id="cb9-87" data-line-number="87">      <span class="cf">for</span> (<span class="kw">let</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> <span class="dv">3</span><span class="op">;</span> <span class="op">++</span>j) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-88" data-line-number="88">        <span class="co">// 詰まっていると見づらかったので、セルとセルの間に空白を1つ入れます。</span></a>
<a class="sourceLine" id="cb9-89" data-line-number="89">        <span class="cf">if</span> (j <span class="op">!=</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-90" data-line-number="90">          lineString <span class="op">+=</span> <span class="st">' '</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-91" data-line-number="91">        <span class="op">}</span></a>
<a class="sourceLine" id="cb9-92" data-line-number="92">        <span class="co">// まだ書き込まれていない場合は「-」、マルかバツならそれを書き込みます。</span></a>
<a class="sourceLine" id="cb9-93" data-line-number="93">        lineString <span class="op">+=</span> [<span class="st">'-'</span><span class="op">,</span> <span class="st">'O'</span><span class="op">,</span> <span class="st">'X'</span>][<span class="kw">this</span>.<span class="va">board</span>.<span class="at">get</span>(i <span class="op">*</span> <span class="dv">3</span> <span class="op">+</span> j)]<span class="op">;</span></a>
<a class="sourceLine" id="cb9-94" data-line-number="94">      <span class="op">}</span></a>
<a class="sourceLine" id="cb9-95" data-line-number="95"></a>
<a class="sourceLine" id="cb9-96" data-line-number="96">      <span class="co">// 1行分を画面に表示します。</span></a>
<a class="sourceLine" id="cb9-97" data-line-number="97">      <span class="va">console</span>.<span class="at">log</span>(lineString)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-98" data-line-number="98">    <span class="op">}</span></a>
<a class="sourceLine" id="cb9-99" data-line-number="99"></a>
<a class="sourceLine" id="cb9-100" data-line-number="100">    <span class="co">// 連続して描画したときに区切りがないとわかりづらいので、もう一度改行しておきます。</span></a>
<a class="sourceLine" id="cb9-101" data-line-number="101">    <span class="va">console</span>.<span class="at">log</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb9-102" data-line-number="102">  <span class="op">}</span></a>
<a class="sourceLine" id="cb9-103" data-line-number="103"><span class="op">}</span></a>
<a class="sourceLine" id="cb9-104" data-line-number="104"></a>
<a class="sourceLine" id="cb9-105" data-line-number="105"><span class="co">// コンピューターのプレイヤー。アルファ・ベータ法（正しくはネガ・アルファ法）で最適な手を打ちます。</span></a>
<a class="sourceLine" id="cb9-106" data-line-number="106"><span class="kw">class</span> ComputerPlayer <span class="kw">extends</span> <span class="va">I</span>.<span class="at">Record</span>(<span class="op">{</span><span class="dt">gameState</span><span class="op">:</span> <span class="kw">null</span><span class="op">}</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-107" data-line-number="107">  <span class="co">// Wikipediaだと1つの関数になっていたのですけど、そのままだと書きづらかったので、これとgetScoreの2つに分けました。</span></a>
<a class="sourceLine" id="cb9-108" data-line-number="108">  <span class="at">getNextScoreAndGameState</span>(gameState<span class="op">,</span> alpha<span class="op">,</span> beta) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-109" data-line-number="109">    <span class="co">// 次に遷移可能なゲーム状態の中で、もっとも良いもののスコアとゲーム状態を入れる変数です。</span></a>
<a class="sourceLine" id="cb9-110" data-line-number="110">    <span class="kw">let</span> nextScoreAndGameState <span class="op">=</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(alpha<span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-111" data-line-number="111"></a>
<a class="sourceLine" id="cb9-112" data-line-number="112">    <span class="co">// 次に遷移可能なゲーム状態全てでループ（ただし、途中で枝刈りされる可能性があります）。</span></a>
<a class="sourceLine" id="cb9-113" data-line-number="113">    <span class="cf">for</span> (<span class="kw">const</span> nextGameState of <span class="va">gameState</span>.<span class="at">nextGameStates</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-114" data-line-number="114">      <span class="co">// 次のゲーム状態のスコアを計算します。</span></a>
<a class="sourceLine" id="cb9-115" data-line-number="115">      <span class="kw">const</span> score <span class="op">=</span> <span class="op">-</span><span class="kw">this</span>.<span class="at">getScore</span>(nextGameState<span class="op">,</span> <span class="op">-</span>beta<span class="op">,</span> <span class="op">-</span><span class="va">nextScoreAndGameState</span>.<span class="at">get</span>(<span class="dv">0</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb9-116" data-line-number="116"></a>
<a class="sourceLine" id="cb9-117" data-line-number="117">      <span class="co">// これまでのスコアよりも良いなら……</span></a>
<a class="sourceLine" id="cb9-118" data-line-number="118">      <span class="cf">if</span> (score <span class="op">&gt;</span> <span class="va">nextScoreAndGameState</span>.<span class="at">get</span>(<span class="dv">0</span>)) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-119" data-line-number="119">        <span class="co">// 入れ替えます。</span></a>
<a class="sourceLine" id="cb9-120" data-line-number="120">        nextScoreAndGameState <span class="op">=</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(score<span class="op">,</span> nextGameState)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-121" data-line-number="121">      <span class="op">}</span></a>
<a class="sourceLine" id="cb9-122" data-line-number="122"></a>
<a class="sourceLine" id="cb9-123" data-line-number="123">      <span class="co">// 枝刈り。詳しくはWikipediaのアルファ・ベータ法を参照してください。</span></a>
<a class="sourceLine" id="cb9-124" data-line-number="124">      <span class="cf">if</span> (<span class="va">nextScoreAndGameState</span>.<span class="at">get</span>(<span class="dv">0</span>) <span class="op">&gt;=</span> beta) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-125" data-line-number="125">        <span class="cf">return</span> nextScoreAndGameState<span class="op">;</span></a>
<a class="sourceLine" id="cb9-126" data-line-number="126">      <span class="op">}</span></a>
<a class="sourceLine" id="cb9-127" data-line-number="127">    <span class="op">}</span></a>
<a class="sourceLine" id="cb9-128" data-line-number="128"></a>
<a class="sourceLine" id="cb9-129" data-line-number="129">    <span class="co">// リターンします。スコアが欲しい場合は最初の値を、ゲーム状態が欲しい場合は2番目の値を使用してください。</span></a>
<a class="sourceLine" id="cb9-130" data-line-number="130">    <span class="cf">return</span> nextScoreAndGameState<span class="op">;</span></a>
<a class="sourceLine" id="cb9-131" data-line-number="131">  <span class="op">};</span></a>
<a class="sourceLine" id="cb9-132" data-line-number="132"></a>
<a class="sourceLine" id="cb9-133" data-line-number="133">  <span class="co">// ゲーム状態のスコアを計算します。</span></a>
<a class="sourceLine" id="cb9-134" data-line-number="134">  <span class="at">getScore</span>(gameState<span class="op">,</span> alpha<span class="op">,</span> beta) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-135" data-line-number="135">    <span class="co">// 勝者を取得します。</span></a>
<a class="sourceLine" id="cb9-136" data-line-number="136">    <span class="kw">const</span> winner <span class="op">=</span> <span class="va">gameState</span>.<span class="at">winner</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-137" data-line-number="137"></a>
<a class="sourceLine" id="cb9-138" data-line-number="138">    <span class="co">// 勝負がついた場合は……</span></a>
<a class="sourceLine" id="cb9-139" data-line-number="139">    <span class="cf">if</span> (winner <span class="op">&gt;=</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-140" data-line-number="140">      <span class="co">// 引き分けなら0、勝ちなら1、負けなら-1をゲーム状態のスコアとします。</span></a>
<a class="sourceLine" id="cb9-141" data-line-number="141">      <span class="cf">return</span> winner <span class="op">==</span> <span class="dv">0</span> <span class="op">?</span> <span class="dv">0</span> : (winner <span class="op">==</span> <span class="va">gameState</span>.<span class="at">nextPlayer</span> <span class="op">?</span> <span class="dv">1</span> : <span class="dv">-1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-142" data-line-number="142">    <span class="op">}</span></a>
<a class="sourceLine" id="cb9-143" data-line-number="143"></a>
<a class="sourceLine" id="cb9-144" data-line-number="144">    <span class="co">// まだ勝負がついていない場合は、遷移可能なゲーム状態のスコアを調べます。</span></a>
<a class="sourceLine" id="cb9-145" data-line-number="145">    <span class="cf">return</span> <span class="kw">this</span>.<span class="at">getNextScoreAndGameState</span>(gameState<span class="op">,</span> alpha<span class="op">,</span> beta).<span class="at">get</span>(<span class="dv">0</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-146" data-line-number="146">  <span class="op">};</span></a>
<a class="sourceLine" id="cb9-147" data-line-number="147"></a>
<a class="sourceLine" id="cb9-148" data-line-number="148">  <span class="co">// もっとも良い、次のゲーム状態を取得します。asyncなのは、HumanPlayerと揃えたためです。</span></a>
<a class="sourceLine" id="cb9-149" data-line-number="149">  async <span class="at">getNextGameState</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb9-150" data-line-number="150">    <span class="cf">return</span> <span class="kw">this</span>.<span class="at">getNextScoreAndGameState</span>(<span class="kw">this</span>.<span class="at">gameState</span><span class="op">,</span> <span class="op">-</span><span class="kw">Infinity</span><span class="op">,</span> <span class="kw">Infinity</span>).<span class="at">get</span>(<span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-151" data-line-number="151">  <span class="op">}</span></a>
<a class="sourceLine" id="cb9-152" data-line-number="152"><span class="op">}</span></a>
<a class="sourceLine" id="cb9-153" data-line-number="153"></a>
<a class="sourceLine" id="cb9-154" data-line-number="154"><span class="co">// 人間のプレイヤー。遷移可能なゲーム状態を画面に表示して、その中から遷移先を選んでもらいます。</span></a>
<a class="sourceLine" id="cb9-155" data-line-number="155"><span class="kw">class</span> HumanPlayer <span class="kw">extends</span> <span class="va">I</span>.<span class="at">Record</span>(<span class="op">{</span><span class="dt">gameState</span><span class="op">:</span> <span class="kw">null</span><span class="op">}</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-156" data-line-number="156">  async <span class="at">getNextGameState</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb9-157" data-line-number="157">    <span class="co">// 現在の状態を表示します。</span></a>
<a class="sourceLine" id="cb9-158" data-line-number="158">    <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`You are player </span><span class="sc">${</span> <span class="kw">this</span>.<span class="va">gameState</span>.<span class="at">nextPlayer</span> <span class="sc">}</span><span class="vs">. Game is below.`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-159" data-line-number="159">    <span class="kw">this</span>.<span class="va">gameState</span>.<span class="at">draw</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb9-160" data-line-number="160"></a>
<a class="sourceLine" id="cb9-161" data-line-number="161">    <span class="co">// 遷移可能なゲーム状態を取得します。</span></a>
<a class="sourceLine" id="cb9-162" data-line-number="162">    <span class="kw">const</span> nextGameStates <span class="op">=</span> <span class="kw">this</span>.<span class="va">gameState</span>.<span class="at">nextGameStates</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-163" data-line-number="163"></a>
<a class="sourceLine" id="cb9-164" data-line-number="164">    <span class="co">// 遷移可能なゲーム状態をすべて表示します。</span></a>
<a class="sourceLine" id="cb9-165" data-line-number="165">    <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="va">nextGameStates</span>.<span class="at">size</span><span class="op">;</span> <span class="op">++</span>i) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-166" data-line-number="166">      <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`No. </span><span class="sc">${</span> i <span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-167" data-line-number="167">      <span class="va">nextGameStates</span>.<span class="at">get</span>(i).<span class="at">draw</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb9-168" data-line-number="168">    <span class="op">}</span></a>
<a class="sourceLine" id="cb9-169" data-line-number="169"></a>
<a class="sourceLine" id="cb9-170" data-line-number="170">    <span class="co">// プレイヤーにゲーム状態を選択してもらいます。エラー・チェックは無視で……。</span></a>
<a class="sourceLine" id="cb9-171" data-line-number="171">    <span class="cf">return</span> await <span class="kw">new</span> <span class="at">Promise</span>(resolve <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb9-172" data-line-number="172">      <span class="kw">const</span> readlineInterface <span class="op">=</span> <span class="va">readline</span>.<span class="at">createInterface</span>(<span class="op">{</span> <span class="dt">input</span><span class="op">:</span> <span class="va">process</span>.<span class="at">stdin</span><span class="op">,</span> <span class="dt">output</span><span class="op">:</span> <span class="va">process</span>.<span class="at">stdout</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-173" data-line-number="173"></a>
<a class="sourceLine" id="cb9-174" data-line-number="174">      <span class="va">readlineInterface</span>.<span class="at">question</span>(<span class="st">'Which do you select? '</span><span class="op">,</span> answer <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb9-175" data-line-number="175">        <span class="at">resolve</span>(<span class="va">nextGameStates</span>.<span class="at">get</span>(answer))<span class="op">;</span></a>
<a class="sourceLine" id="cb9-176" data-line-number="176">        <span class="va">readlineInterface</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb9-177" data-line-number="177">      <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-178" data-line-number="178">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-179" data-line-number="179">  <span class="op">}</span></a>
<a class="sourceLine" id="cb9-180" data-line-number="180"><span class="op">}</span></a>
<a class="sourceLine" id="cb9-181" data-line-number="181"></a>
<a class="sourceLine" id="cb9-182" data-line-number="182"><span class="co">// ゲーム。</span></a>
<a class="sourceLine" id="cb9-183" data-line-number="183"><span class="im">export</span> <span class="im">default</span> <span class="kw">class</span> TicTacToe <span class="op">{</span></a>
<a class="sourceLine" id="cb9-184" data-line-number="184">  <span class="at">constructor</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb9-185" data-line-number="185">    <span class="kw">this</span>.<span class="at">gameState</span> <span class="op">=</span> <span class="kw">new</span> <span class="at">GameState</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb9-186" data-line-number="186">  <span class="op">}</span></a>
<a class="sourceLine" id="cb9-187" data-line-number="187"></a>
<a class="sourceLine" id="cb9-188" data-line-number="188">  <span class="co">// 勝者を表示してtrueを返します。勝負がついていない場合は、何もしないでfalseを返します。</span></a>
<a class="sourceLine" id="cb9-189" data-line-number="189">  <span class="at">drawWinner</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb9-190" data-line-number="190">    <span class="kw">const</span> winner <span class="op">=</span> <span class="kw">this</span>.<span class="va">gameState</span>.<span class="at">winner</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-191" data-line-number="191">    <span class="cf">if</span> (winner <span class="op">&lt;</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-192" data-line-number="192">      <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-193" data-line-number="193">    <span class="op">}</span></a>
<a class="sourceLine" id="cb9-194" data-line-number="194"></a>
<a class="sourceLine" id="cb9-195" data-line-number="195">    <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Player </span><span class="sc">${</span> [<span class="st">'-'</span><span class="op">,</span> <span class="st">'1'</span><span class="op">,</span> <span class="st">'2'</span>][winner] <span class="sc">}</span><span class="vs"> win!`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb9-196" data-line-number="196">    <span class="kw">this</span>.<span class="va">gameState</span>.<span class="at">draw</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb9-197" data-line-number="197"></a>
<a class="sourceLine" id="cb9-198" data-line-number="198">    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-199" data-line-number="199">  <span class="op">}</span></a>
<a class="sourceLine" id="cb9-200" data-line-number="200"></a>
<a class="sourceLine" id="cb9-201" data-line-number="201">  <span class="co">// ゲーム開始。</span></a>
<a class="sourceLine" id="cb9-202" data-line-number="202">  async <span class="at">start</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb9-203" data-line-number="203">    <span class="co">// 無限ループ。</span></a>
<a class="sourceLine" id="cb9-204" data-line-number="204">    <span class="cf">while</span> (<span class="kw">true</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-205" data-line-number="205">      <span class="co">// 勝負がついたなら、勝者を表示して終了。</span></a>
<a class="sourceLine" id="cb9-206" data-line-number="206">      <span class="cf">if</span> (<span class="kw">this</span>.<span class="at">drawWinner</span>()) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-207" data-line-number="207">        <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-208" data-line-number="208">      <span class="op">}</span></a>
<a class="sourceLine" id="cb9-209" data-line-number="209"></a>
<a class="sourceLine" id="cb9-210" data-line-number="210">      <span class="co">// 人間のターン。</span></a>
<a class="sourceLine" id="cb9-211" data-line-number="211">      <span class="kw">this</span>.<span class="at">gameState</span> <span class="op">=</span> await <span class="kw">new</span> <span class="at">HumanPlayer</span>(<span class="op">{</span><span class="dt">gameState</span><span class="op">:</span> <span class="kw">this</span>.<span class="at">gameState</span><span class="op">}</span>).<span class="at">getNextGameState</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb9-212" data-line-number="212"></a>
<a class="sourceLine" id="cb9-213" data-line-number="213">      <span class="co">// 勝負がついたなら、勝者を表示して終了。</span></a>
<a class="sourceLine" id="cb9-214" data-line-number="214">      <span class="cf">if</span> (<span class="kw">this</span>.<span class="at">drawWinner</span>()) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-215" data-line-number="215">        <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-216" data-line-number="216">      <span class="op">}</span></a>
<a class="sourceLine" id="cb9-217" data-line-number="217"></a>
<a class="sourceLine" id="cb9-218" data-line-number="218">      <span class="co">// コンピューターのターン。</span></a>
<a class="sourceLine" id="cb9-219" data-line-number="219">      <span class="kw">this</span>.<span class="at">gameState</span> <span class="op">=</span> await <span class="kw">new</span> <span class="at">ComputerPlayer</span>(<span class="op">{</span><span class="dt">gameState</span><span class="op">:</span> <span class="kw">this</span>.<span class="at">gameState</span><span class="op">}</span>).<span class="at">getNextGameState</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb9-220" data-line-number="220">     <span class="op">}</span></a>
<a class="sourceLine" id="cb9-221" data-line-number="221">  <span class="op">}</span></a>
<a class="sourceLine" id="cb9-222" data-line-number="222"><span class="op">}</span></a></code></pre></div>
<p>えっと、長くてごめんなさい。ともあれ、これで絶対に負けない三目並べが完成しました。Node.jsをインストール済みの人は、GitHubからコードをクローンして試してみてください。あなたがどれだけ優秀な三目並べ屋だとしても、このプログラムは絶対に負けないはず……なのですけど、もしバグがあって負けちゃったらこっそり教えてください。</p>
<p>で、コード中のコメントにも書きましたけど、メソッドの中にイミュータブル「ではない」変数がいっぱいですね。あと、なんだか<code>for</code>文の中身が似ている場合が多い気もします。<code>GameState.vacantCellCount</code>の<code>for</code>文と<code>GameState.winner</code>の内側の<code>for</code>文とか。</p>
<h2>集合に対する操作は、ライブラリ化できます</h2>
<p>まぁもっとも、先程のコードは、Immutable.jsの人が見たら激怒しちゃうような悪いコードなんですけどね。</p>
<p>例えば<code>GameState.vacantCellCount()</code>は、Immutable.jsの<code>List</code>の<code>filter()</code>メソッドとラムダ式を使用して、以下のような書き方をすべきでしょう。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb10-1" data-line-number="1">get <span class="at">vacantCellCount</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">  <span class="co">// ボードの</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3">  <span class="cf">return</span> <span class="kw">this</span>.<span class="at">board</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4">    <span class="co">// 値が0のセルの、</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5">    .<span class="at">filter</span>(cell <span class="op">=&gt;</span> cell <span class="op">==</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb10-6" data-line-number="6">    <span class="co">// 数を返します。</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7">    .<span class="at">size</span><span class="op">;</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8"><span class="op">}</span></a></code></pre></div>
<p>＃以下、filterやmap、reduceなどの集合操作の説明が続きます。すでにご存知の方は、説明は無視して、次の長いコードまでスキップしてください。</p>
<p>この<code>filter()</code>というのは、リストの要素を抽出するメソッドです。以下のようなコードがあった場合で考えてみましょう。</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">function</span> <span class="at">getDevelopersByLanguage</span>(developers<span class="op">,</span> language) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">  <span class="kw">const</span> result <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"></a>
<a class="sourceLine" id="cb11-4" data-line-number="4">  <span class="cf">for</span> (<span class="kw">const</span> developer of developers) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5">    <span class="cf">if</span> (<span class="va">developer</span>.<span class="at">language</span> <span class="op">!=</span> language) <span class="op">{</span>  <span class="co">// 下の関数と違うのは、ここだけ。</span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6">      <span class="cf">continue</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7">    <span class="op">}</span></a>
<a class="sourceLine" id="cb11-8" data-line-number="8"></a>
<a class="sourceLine" id="cb11-9" data-line-number="9">    <span class="va">result</span>.<span class="at">push</span>(developer)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-10" data-line-number="10">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-11" data-line-number="11"></a>
<a class="sourceLine" id="cb11-12" data-line-number="12">  <span class="cf">return</span> result<span class="op">;</span></a>
<a class="sourceLine" id="cb11-13" data-line-number="13"><span class="op">}</span></a>
<a class="sourceLine" id="cb11-14" data-line-number="14"></a>
<a class="sourceLine" id="cb11-15" data-line-number="15"><span class="kw">function</span> <span class="at">getDevelopersBySex</span>(developers<span class="op">,</span> sex) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-16" data-line-number="16">  <span class="kw">const</span> result <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb11-17" data-line-number="17"></a>
<a class="sourceLine" id="cb11-18" data-line-number="18">  <span class="cf">for</span> (<span class="kw">const</span> developer of developers) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-19" data-line-number="19">    <span class="cf">if</span> (<span class="va">developer</span>.<span class="at">sex</span> <span class="op">!=</span> sex) <span class="op">{</span>  <span class="co">// 上の関数と違うのは、ここだけ。</span></a>
<a class="sourceLine" id="cb11-20" data-line-number="20">      <span class="cf">continue</span><span class="op">;</span></a>
<a class="sourceLine" id="cb11-21" data-line-number="21">    <span class="op">}</span></a>
<a class="sourceLine" id="cb11-22" data-line-number="22"></a>
<a class="sourceLine" id="cb11-23" data-line-number="23">    <span class="va">result</span>.<span class="at">push</span>(developer)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-24" data-line-number="24">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-25" data-line-number="25"></a>
<a class="sourceLine" id="cb11-26" data-line-number="26">  <span class="cf">return</span> result<span class="op">;</span></a>
<a class="sourceLine" id="cb11-27" data-line-number="27"><span class="op">}</span></a></code></pre></div>
<p>このコード、「途中の<code>if</code>文の条件以外は一緒」なわけで、条件部分を外出して共通化したいですよね？　でも、条件や演算子を引数で渡す方式<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a>は汎用性が低いのでダメです。条件部分を「関数」として抜き出すことにして、関数をその場で定義できるラムダ式を活用する、<code>filter</code>という関数を作りましょう。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw">function</span> <span class="at">filter</span>(xs<span class="op">,</span> f) <span class="op">{</span>  <span class="co">// fは関数</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2">  <span class="kw">const</span> result <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"></a>
<a class="sourceLine" id="cb12-4" data-line-number="4">  <span class="cf">for</span> (<span class="kw">const</span> x of xs) <span class="op">{</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5">    <span class="cf">if</span> (<span class="op">!</span><span class="at">f</span>(x)) <span class="op">{</span>  <span class="co">// 引数で受け取った関数を呼び出して、残すかどうかを判定します。</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6">      <span class="cf">continue</span><span class="op">;</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7">    <span class="op">}</span></a>
<a class="sourceLine" id="cb12-8" data-line-number="8"></a>
<a class="sourceLine" id="cb12-9" data-line-number="9">    <span class="va">result</span>.<span class="at">push</span>(x)<span class="op">;</span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10">  <span class="op">}</span></a>
<a class="sourceLine" id="cb12-11" data-line-number="11"></a>
<a class="sourceLine" id="cb12-12" data-line-number="12">  <span class="cf">return</span> result<span class="op">;</span></a>
<a class="sourceLine" id="cb12-13" data-line-number="13"><span class="op">}</span></a>
<a class="sourceLine" id="cb12-14" data-line-number="14"></a>
<a class="sourceLine" id="cb12-15" data-line-number="15"><span class="va">console</span>.<span class="at">log</span>(<span class="at">filter</span>(developers<span class="op">,</span> x <span class="op">=&gt;</span> <span class="va">x</span>.<span class="at">language</span> <span class="op">==</span> <span class="st">'ECMAScript'</span> <span class="op">&amp;&amp;</span> <span class="va">x</span>.<span class="at">sex</span> <span class="op">==</span> <span class="st">'Female'</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb12-16" data-line-number="16"><span class="va">console</span>.<span class="at">log</span>(<span class="at">filter</span>(<span class="at">filter</span>(developers<span class="op">,</span></a>
<a class="sourceLine" id="cb12-17" data-line-number="17">                          developer <span class="op">=&gt;</span> <span class="va">developer</span>.<span class="at">language</span> <span class="op">==</span> <span class="st">'ECMAScript'</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb12-18" data-line-number="18">                   developer <span class="op">=&gt;</span> <span class="va">developer</span>.<span class="at">sex</span> <span class="op">==</span> <span class="st">'Female'</span>))<span class="op">;</span></a></code></pre></div>
<p>ほら、これでコード量が激減しました。</p>
<p>集合に対する操作は、他にもあります。たとえば、要素の属性を取得するような場合がありますけど、</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw">function</span> <span class="at">getDeveloperNames</span>(developers) <span class="op">{</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2">  <span class="kw">const</span> result <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"></a>
<a class="sourceLine" id="cb13-4" data-line-number="4">  <span class="cf">for</span> (<span class="kw">const</span> developer of developers) <span class="op">{</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5">    <span class="va">result</span>.<span class="at">push</span>(<span class="va">developer</span>.<span class="at">name</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6">  <span class="op">}</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7"></a>
<a class="sourceLine" id="cb13-8" data-line-number="8">  <span class="cf">return</span> result<span class="op">;</span></a>
<a class="sourceLine" id="cb13-9" data-line-number="9"><span class="op">}</span></a></code></pre></div>
<p>この場合も同じやり方でライブラリ化できます。</p>
<pre class="javascriopt"><code>function map(xs, f) {
  const result = [];

  for (const x of xs) {
    result.push(f(x));  // 引数で受け取った関数を使用して、別の値（属性の値とか）に変換します。
  }

  return result;
}

console.log(map(filter(developers,
                       developer =&gt; developer.language == 'ECMAScript'),
                developer =&gt; developer.name));</code></pre>
<p>あとはアレだ、合計を出すような場合ですよ。</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="kw">function</span> <span class="at">getTotalSalary</span>(developers) <span class="op">{</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2">  <span class="kw">let</span> result <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"></a>
<a class="sourceLine" id="cb15-4" data-line-number="4">  <span class="cf">for</span> (<span class="kw">const</span> developer of developers) <span class="op">{</span></a>
<a class="sourceLine" id="cb15-5" data-line-number="5">    result <span class="op">=</span> result <span class="op">+</span> <span class="va">developer</span>.<span class="at">salary</span><span class="op">;</span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6">  <span class="op">}</span></a>
<a class="sourceLine" id="cb15-7" data-line-number="7"></a>
<a class="sourceLine" id="cb15-8" data-line-number="8">  <span class="cf">return</span> result<span class="op">;</span></a>
<a class="sourceLine" id="cb15-9" data-line-number="9"><span class="op">}</span></a></code></pre></div>
<p>この場合はちょっと複雑で、引数に渡す関数の引数はそれまでの合計と集合の要素の2つになります（関数として抜き出すのは<code>result + developer.salary</code>の部分ですもんね）。あと、<code>result</code>の初期値も必要です。というわけで、こんな感じ。</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="kw">function</span> <span class="at">reduce</span>(xs<span class="op">,</span> f<span class="op">,</span> initValue) <span class="op">{</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2">  <span class="kw">let</span> result <span class="op">=</span> initValue<span class="op">;</span></a>
<a class="sourceLine" id="cb16-3" data-line-number="3"></a>
<a class="sourceLine" id="cb16-4" data-line-number="4">  <span class="cf">for</span> (<span class="kw">const</span> x of xs) <span class="op">{</span></a>
<a class="sourceLine" id="cb16-5" data-line-number="5">    result <span class="op">=</span> <span class="at">f</span>(result<span class="op">,</span> x)<span class="op">;</span></a>
<a class="sourceLine" id="cb16-6" data-line-number="6">  <span class="op">}</span></a>
<a class="sourceLine" id="cb16-7" data-line-number="7"></a>
<a class="sourceLine" id="cb16-8" data-line-number="8">  <span class="cf">return</span> result<span class="op">;</span></a>
<a class="sourceLine" id="cb16-9" data-line-number="9"><span class="op">}</span></a>
<a class="sourceLine" id="cb16-10" data-line-number="10"></a>
<a class="sourceLine" id="cb16-11" data-line-number="11"><span class="va">console</span>.<span class="at">log</span>(<span class="at">reduce</span>(<span class="at">filter</span>(developers<span class="op">,</span></a>
<a class="sourceLine" id="cb16-12" data-line-number="12">                          developer <span class="op">=&gt;</span> <span class="va">developer</span>.<span class="at">language</span> <span class="op">==</span> <span class="st">'ECMAScript'</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb16-13" data-line-number="13">                   (totalSalary<span class="op">,</span> developer) <span class="op">=&gt;</span> totalSalary <span class="op">+</span> <span class="va">developer</span>.<span class="at">salary</span><span class="op">,</span></a>
<a class="sourceLine" id="cb16-14" data-line-number="14">                   <span class="dv">0</span>))<span class="op">;</span></a></code></pre></div>
<p>あとは、集合の1番目の要素を取得するための<code>first()</code>や2番目から最後までを取得する<code>rest()</code>とか（再帰で１つづつ処理したい場合などに便利。ライブラリによっては、名前が<code>head()</code>と<code>tail()</code>だったり<code>car</code>と<code>cdr</code>だったりします）、すべての要素が条件を満たすかを調べる<code>every()</code>や一個でも条件を満たす要素があるかを調べる<code>some()</code>なんてのもあります（ライブラリによっては、名前が<code>all()</code>と<code>some()</code>だったりします）。</p>
<p>と、ここまで書いたところで気がついたのですけど、先程書き直した<code>GameState.vacantCellCount()</code>、これは不要でしたね。<code>vacantCellCount</code>を呼び出している箇所は2箇所あって、ゲームが終了しているか否かを判断する<code>GameState.winner()</code>の後半と次のプレイヤーを決める<code>GameState.nextPlayer()</code>。で、ゲームが終了しているか否かを判断するには値が0のセルが1つでもあればよくて（<code>some()</code>だけでよい）、次のプレイヤーを決めるには値が0のセルの数を最後まで調べなければならない（<code>filter()</code>して<code>size</code>を調べないとダメ）。<code>GameState.winner()</code>の場合に、<code>GameState.vacantCellCount()</code>だと余計な処理をしちゃっていたんですね。</p>
<p>というわけで、書き直し。</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb17-1" data-line-number="1">get <span class="at">winner</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2">  <span class="kw">const</span> winningLines <span class="op">=</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">6</span>)<span class="op">,</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">7</span>)<span class="op">,</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">2</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">8</span>)<span class="op">,</span>  <span class="co">// 縦</span></a>
<a class="sourceLine" id="cb17-3" data-line-number="3">                                 <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">,</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span>)<span class="op">,</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">6</span><span class="op">,</span> <span class="dv">7</span><span class="op">,</span> <span class="dv">8</span>)<span class="op">,</span>  <span class="co">// 横</span></a>
<a class="sourceLine" id="cb17-4" data-line-number="4">                                 <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">8</span>)<span class="op">,</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">2</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">6</span>))<span class="op">;</span>                     <span class="co">// 斜め</span></a>
<a class="sourceLine" id="cb17-5" data-line-number="5"></a>
<a class="sourceLine" id="cb17-6" data-line-number="6">  <span class="co">// winningLinesの集合を、</span></a>
<a class="sourceLine" id="cb17-7" data-line-number="7">  <span class="kw">const</span> winner <span class="op">=</span> winningLines</a>
<a class="sourceLine" id="cb17-8" data-line-number="8">        <span class="co">// セルの値の集合の集合に変換して、</span></a>
<a class="sourceLine" id="cb17-9" data-line-number="9">        .<span class="at">map</span>(line <span class="op">=&gt;</span> <span class="va">line</span>.<span class="at">map</span>(index <span class="op">=&gt;</span> <span class="kw">this</span>.<span class="va">board</span>.<span class="at">get</span>(index)))</a>
<a class="sourceLine" id="cb17-10" data-line-number="10">        <span class="co">// セルの値の集合の残りが1つ目とすべて同じ場合、かつ、1つ目が0でない集合の、</span></a>
<a class="sourceLine" id="cb17-11" data-line-number="11">        .<span class="at">filter</span>(cells <span class="op">=&gt;</span> <span class="va">cells</span>.<span class="at">rest</span>().<span class="at">every</span>(cell <span class="op">=&gt;</span> cell <span class="op">==</span> <span class="va">cells</span>.<span class="at">first</span>()) <span class="op">&amp;&amp;</span> <span class="va">cells</span>.<span class="at">first</span>() <span class="op">!=</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb17-12" data-line-number="12">        <span class="co">// 1つ目の要素だけ残して、</span></a>
<a class="sourceLine" id="cb17-13" data-line-number="13">        .<span class="at">map</span>(cells <span class="op">=&gt;</span> <span class="va">cells</span>.<span class="at">first</span>())</a>
<a class="sourceLine" id="cb17-14" data-line-number="14">        <span class="co">// さらに1つ目。[[1, 1, 2], [2, 2, 2], ...]→[[2, 2, 2], ...]→[2, ...]→2</span></a>
<a class="sourceLine" id="cb17-15" data-line-number="15">        .<span class="at">first</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb17-16" data-line-number="16"></a>
<a class="sourceLine" id="cb17-17" data-line-number="17">  <span class="co">// もし勝者がいるなら（空集合のfirst()はundefinedを返す。JavaScriptでは0は偽なので、プレイヤー番号を1から始めています）、</span></a>
<a class="sourceLine" id="cb17-18" data-line-number="18">  <span class="cf">if</span> (winner) <span class="op">{</span></a>
<a class="sourceLine" id="cb17-19" data-line-number="19">    <span class="co">// 勝者を返します。</span></a>
<a class="sourceLine" id="cb17-20" data-line-number="20">    <span class="cf">return</span> winner<span class="op">;</span></a>
<a class="sourceLine" id="cb17-21" data-line-number="21">  <span class="op">}</span></a>
<a class="sourceLine" id="cb17-22" data-line-number="22"></a>
<a class="sourceLine" id="cb17-23" data-line-number="23">  <span class="co">// 値が0のセルが1つでもあるなら試合続行、そうでなければ引き分けを返します。</span></a>
<a class="sourceLine" id="cb17-24" data-line-number="24">  <span class="cf">return</span> <span class="kw">this</span>.<span class="va">board</span>.<span class="at">some</span>(cell <span class="op">=&gt;</span> cell <span class="op">==</span> <span class="dv">0</span>) <span class="op">?</span> <span class="dv">-1</span> : <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb17-25" data-line-number="25"><span class="op">}</span></a>
<a class="sourceLine" id="cb17-26" data-line-number="26"></a>
<a class="sourceLine" id="cb17-27" data-line-number="27">get <span class="at">nextPlayer</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb17-28" data-line-number="28">  <span class="co">// 値が0のセルの数を2で割った余りが1ならばプレイヤー1、そうでなければプレイヤー2を返します。</span></a>
<a class="sourceLine" id="cb17-29" data-line-number="29">  <span class="cf">return</span> <span class="kw">this</span>.<span class="va">board</span>.<span class="at">filter</span>(cell <span class="op">=&gt;</span> cell <span class="op">==</span> <span class="dv">0</span>).<span class="at">size</span> <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">1</span> <span class="op">?</span> <span class="dv">1</span> : <span class="dv">2</span><span class="op">;</span></a>
<a class="sourceLine" id="cb17-30" data-line-number="30"><span class="op">}</span></a></code></pre></div>
<p>おお。短くなった上に分かりやすい。Immutable.jsには、他にもインデックスと要素の配列の集合に変換してくれる<code>entrySeq()</code>や指定した範囲の数値の集合を生成してくれる<code>Range()</code>や値を繰り返して集合を生成してくれる<code>Repeat()</code>、集合の集合（<code>[[1, 2], [3, 4]]</code>）をフラット（<code>[1, 2, 3, 4]</code>）にしてくれる<code>flatten()</code>なんてのもあります。</p>
<p>というわけで、これらのImmutable.jsの便利な機能を活用して、コードを書き直してみました。</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="im">import</span> I        <span class="im">from</span> <span class="st">'immutable'</span><span class="op">;</span></a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="im">import</span> process  <span class="im">from</span> <span class="st">'process'</span><span class="op">;</span></a>
<a class="sourceLine" id="cb18-3" data-line-number="3"><span class="im">import</span> readline <span class="im">from</span> <span class="st">'readline'</span><span class="op">;</span></a>
<a class="sourceLine" id="cb18-4" data-line-number="4"></a>
<a class="sourceLine" id="cb18-5" data-line-number="5"><span class="kw">class</span> GameState <span class="kw">extends</span> <span class="va">I</span>.<span class="at">Record</span>(<span class="op">{</span><span class="dt">board</span><span class="op">:</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">}</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb18-6" data-line-number="6">  get <span class="at">winner</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb18-7" data-line-number="7">    <span class="kw">const</span> winningLines <span class="op">=</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">6</span>)<span class="op">,</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">7</span>)<span class="op">,</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">2</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">8</span>)<span class="op">,</span>  <span class="co">// 縦</span></a>
<a class="sourceLine" id="cb18-8" data-line-number="8">                                   <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">,</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span>)<span class="op">,</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">6</span><span class="op">,</span> <span class="dv">7</span><span class="op">,</span> <span class="dv">8</span>)<span class="op">,</span>  <span class="co">// 横</span></a>
<a class="sourceLine" id="cb18-9" data-line-number="9">                                   <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">8</span>)<span class="op">,</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="dv">2</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">6</span>))<span class="op">;</span>                     <span class="co">// 斜め</span></a>
<a class="sourceLine" id="cb18-10" data-line-number="10"></a>
<a class="sourceLine" id="cb18-11" data-line-number="11">    <span class="kw">const</span> winner <span class="op">=</span> winningLines</a>
<a class="sourceLine" id="cb18-12" data-line-number="12">      .<span class="at">map</span>(line <span class="op">=&gt;</span> <span class="va">line</span>.<span class="at">map</span>(index <span class="op">=&gt;</span> <span class="kw">this</span>.<span class="va">board</span>.<span class="at">get</span>(index)))</a>
<a class="sourceLine" id="cb18-13" data-line-number="13">      .<span class="at">filter</span>(cells <span class="op">=&gt;</span> <span class="va">cells</span>.<span class="at">rest</span>().<span class="at">every</span>(cell <span class="op">=&gt;</span> cell <span class="op">==</span> <span class="va">cells</span>.<span class="at">first</span>()) <span class="op">&amp;&amp;</span> <span class="va">cells</span>.<span class="at">first</span>() <span class="op">!=</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb18-14" data-line-number="14">      .<span class="at">map</span>(cells <span class="op">=&gt;</span> <span class="va">cells</span>.<span class="at">first</span>())</a>
<a class="sourceLine" id="cb18-15" data-line-number="15">      .<span class="at">first</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb18-16" data-line-number="16"></a>
<a class="sourceLine" id="cb18-17" data-line-number="17">    <span class="cf">if</span> (winner) <span class="op">{</span></a>
<a class="sourceLine" id="cb18-18" data-line-number="18">      <span class="cf">return</span> winner<span class="op">;</span></a>
<a class="sourceLine" id="cb18-19" data-line-number="19">    <span class="op">}</span></a>
<a class="sourceLine" id="cb18-20" data-line-number="20"></a>
<a class="sourceLine" id="cb18-21" data-line-number="21">    <span class="cf">return</span> <span class="kw">this</span>.<span class="va">board</span>.<span class="at">some</span>(cell <span class="op">=&gt;</span> cell <span class="op">==</span> <span class="dv">0</span>) <span class="op">?</span> <span class="dv">-1</span> : <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb18-22" data-line-number="22">  <span class="op">}</span></a>
<a class="sourceLine" id="cb18-23" data-line-number="23"></a>
<a class="sourceLine" id="cb18-24" data-line-number="24">  get <span class="at">nextPlayer</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb18-25" data-line-number="25">    <span class="cf">return</span> <span class="kw">this</span>.<span class="va">board</span>.<span class="at">filter</span>(cell <span class="op">=&gt;</span> cell <span class="op">==</span> <span class="dv">0</span>).<span class="at">size</span> <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">1</span> <span class="op">?</span> <span class="dv">1</span> : <span class="dv">2</span><span class="op">;</span></a>
<a class="sourceLine" id="cb18-26" data-line-number="26">  <span class="op">}</span></a>
<a class="sourceLine" id="cb18-27" data-line-number="27"></a>
<a class="sourceLine" id="cb18-28" data-line-number="28">  get <span class="at">nextGameStates</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb18-29" data-line-number="29">    <span class="cf">return</span> <span class="kw">this</span>.<span class="va">board</span>.<span class="at">entrySeq</span>()</a>
<a class="sourceLine" id="cb18-30" data-line-number="30">      .<span class="at">filter</span>(entry <span class="op">=&gt;</span> entry[<span class="dv">1</span>] <span class="op">==</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb18-31" data-line-number="31">      .<span class="at">map</span>(entry <span class="op">=&gt;</span> <span class="kw">this</span>.<span class="at">setIn</span>(<span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="st">'board'</span><span class="op">,</span> entry[<span class="dv">0</span>])<span class="op">,</span> <span class="kw">this</span>.<span class="at">nextPlayer</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb18-32" data-line-number="32">  <span class="op">}</span></a>
<a class="sourceLine" id="cb18-33" data-line-number="33"></a>
<a class="sourceLine" id="cb18-34" data-line-number="34">  <span class="at">draw</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb18-35" data-line-number="35">    <span class="kw">const</span> boardString <span class="op">=</span> (</a>
<a class="sourceLine" id="cb18-36" data-line-number="36">      <span class="va">I</span>.<span class="at">Range</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb18-37" data-line-number="37">        .<span class="at">map</span>(i <span class="op">=&gt;</span> <span class="kw">this</span>.<span class="va">board</span>.<span class="at">slice</span>(i <span class="op">*</span> <span class="dv">3</span><span class="op">,</span> i <span class="op">*</span> <span class="dv">3</span> <span class="op">+</span> <span class="dv">3</span>))</a>
<a class="sourceLine" id="cb18-38" data-line-number="38">        .<span class="at">map</span>(cells <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb18-39" data-line-number="39">          <span class="cf">return</span> cells</a>
<a class="sourceLine" id="cb18-40" data-line-number="40">            .<span class="at">map</span>(cell <span class="op">=&gt;</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="st">'-'</span><span class="op">,</span> <span class="st">'O'</span><span class="op">,</span> <span class="st">'X'</span>).<span class="at">get</span>(cell))</a>
<a class="sourceLine" id="cb18-41" data-line-number="41">            .<span class="at">interpose</span>(<span class="st">' '</span>)</a>
<a class="sourceLine" id="cb18-42" data-line-number="42">            .<span class="at">reduce</span>((acc<span class="op">,</span> cellString) <span class="op">=&gt;</span> <span class="vs">`</span><span class="sc">${</span> acc <span class="sc">}${</span> cellString  <span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb18-43" data-line-number="43">        <span class="op">}</span>)</a>
<a class="sourceLine" id="cb18-44" data-line-number="44">        .<span class="at">interpose</span>(<span class="st">'</span><span class="sc">\n</span><span class="st">'</span>)</a>
<a class="sourceLine" id="cb18-45" data-line-number="45">        .<span class="at">reduce</span>((acc<span class="op">,</span> lineString) <span class="op">=&gt;</span> <span class="vs">`</span><span class="sc">${</span> acc <span class="sc">}${</span> lineString <span class="sc">}</span><span class="vs">`</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb18-46" data-line-number="46"></a>
<a class="sourceLine" id="cb18-47" data-line-number="47">    <span class="va">console</span>.<span class="at">log</span>(boardString)<span class="op">;</span></a>
<a class="sourceLine" id="cb18-48" data-line-number="48">    <span class="va">console</span>.<span class="at">log</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb18-49" data-line-number="49">  <span class="op">}</span></a>
<a class="sourceLine" id="cb18-50" data-line-number="50"><span class="op">}</span></a>
<a class="sourceLine" id="cb18-51" data-line-number="51"></a>
<a class="sourceLine" id="cb18-52" data-line-number="52"><span class="kw">class</span> ComputerPlayer <span class="kw">extends</span> <span class="va">I</span>.<span class="at">Record</span>(<span class="op">{</span><span class="dt">gameState</span><span class="op">:</span> <span class="kw">null</span><span class="op">}</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb18-53" data-line-number="53">  <span class="at">getNextScoreAndGameState</span>(gameState<span class="op">,</span> alpha<span class="op">,</span> beta) <span class="op">{</span></a>
<a class="sourceLine" id="cb18-54" data-line-number="54">    <span class="co">// Immutable.jsのreduceを途中で止める方法が分からなくて枝刈りできなかったので、ごめんなさい、for文のままです。</span></a>
<a class="sourceLine" id="cb18-55" data-line-number="55">    <span class="co">// reducerの引数iterはES6のIteratorで、iter.done=trueにすれば止まるんだと思っていたら、Immutable.jsのSeqだった……。</span></a>
<a class="sourceLine" id="cb18-56" data-line-number="56"></a>
<a class="sourceLine" id="cb18-57" data-line-number="57">    <span class="kw">let</span> nextScoreAndGameState <span class="op">=</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(alpha<span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb18-58" data-line-number="58"></a>
<a class="sourceLine" id="cb18-59" data-line-number="59">    <span class="cf">for</span> (<span class="kw">const</span> nextGameState of <span class="va">gameState</span>.<span class="at">nextGameStates</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb18-60" data-line-number="60">      <span class="kw">const</span> score <span class="op">=</span> <span class="op">-</span><span class="kw">this</span>.<span class="at">getScore</span>(nextGameState<span class="op">,</span> <span class="op">-</span>beta<span class="op">,</span> <span class="op">-</span><span class="va">nextScoreAndGameState</span>.<span class="at">get</span>(<span class="dv">0</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb18-61" data-line-number="61">      <span class="cf">if</span> (score <span class="op">&gt;</span> <span class="va">nextScoreAndGameState</span>.<span class="at">get</span>(<span class="dv">0</span>)) <span class="op">{</span></a>
<a class="sourceLine" id="cb18-62" data-line-number="62">        nextScoreAndGameState <span class="op">=</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(score<span class="op">,</span> nextGameState)<span class="op">;</span></a>
<a class="sourceLine" id="cb18-63" data-line-number="63">      <span class="op">}</span></a>
<a class="sourceLine" id="cb18-64" data-line-number="64"></a>
<a class="sourceLine" id="cb18-65" data-line-number="65">      <span class="co">// 枝刈り</span></a>
<a class="sourceLine" id="cb18-66" data-line-number="66">      <span class="cf">if</span> (<span class="va">nextScoreAndGameState</span>.<span class="at">get</span>(<span class="dv">0</span>) <span class="op">&gt;=</span> beta) <span class="op">{</span></a>
<a class="sourceLine" id="cb18-67" data-line-number="67">        <span class="cf">return</span> nextScoreAndGameState<span class="op">;</span></a>
<a class="sourceLine" id="cb18-68" data-line-number="68">      <span class="op">}</span></a>
<a class="sourceLine" id="cb18-69" data-line-number="69">    <span class="op">}</span></a>
<a class="sourceLine" id="cb18-70" data-line-number="70"></a>
<a class="sourceLine" id="cb18-71" data-line-number="71">    <span class="cf">return</span> nextScoreAndGameState<span class="op">;</span></a>
<a class="sourceLine" id="cb18-72" data-line-number="72">  <span class="op">};</span></a>
<a class="sourceLine" id="cb18-73" data-line-number="73"></a>
<a class="sourceLine" id="cb18-74" data-line-number="74">  <span class="at">getScore</span>(gameState<span class="op">,</span> alpha<span class="op">,</span> beta) <span class="op">{</span></a>
<a class="sourceLine" id="cb18-75" data-line-number="75">    <span class="kw">const</span> winner <span class="op">=</span> <span class="va">gameState</span>.<span class="at">winner</span><span class="op">;</span></a>
<a class="sourceLine" id="cb18-76" data-line-number="76">    <span class="cf">if</span> (winner <span class="op">&gt;=</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb18-77" data-line-number="77">      <span class="cf">return</span> winner <span class="op">==</span> <span class="dv">0</span> <span class="op">?</span> <span class="dv">0</span> : (winner <span class="op">==</span> <span class="va">gameState</span>.<span class="at">nextPlayer</span> <span class="op">?</span> <span class="dv">1</span> : <span class="dv">-1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb18-78" data-line-number="78">    <span class="op">}</span></a>
<a class="sourceLine" id="cb18-79" data-line-number="79"></a>
<a class="sourceLine" id="cb18-80" data-line-number="80">    <span class="cf">return</span> <span class="kw">this</span>.<span class="at">getNextScoreAndGameState</span>(gameState<span class="op">,</span> alpha<span class="op">,</span> beta).<span class="at">get</span>(<span class="dv">0</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb18-81" data-line-number="81">  <span class="op">};</span></a>
<a class="sourceLine" id="cb18-82" data-line-number="82"></a>
<a class="sourceLine" id="cb18-83" data-line-number="83">  async <span class="at">getNextGameState</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb18-84" data-line-number="84">    <span class="cf">return</span> <span class="kw">this</span>.<span class="at">getNextScoreAndGameState</span>(<span class="kw">this</span>.<span class="at">gameState</span><span class="op">,</span> <span class="op">-</span><span class="kw">Infinity</span><span class="op">,</span> <span class="kw">Infinity</span>).<span class="at">get</span>(<span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb18-85" data-line-number="85">  <span class="op">}</span></a>
<a class="sourceLine" id="cb18-86" data-line-number="86"><span class="op">}</span></a>
<a class="sourceLine" id="cb18-87" data-line-number="87"></a>
<a class="sourceLine" id="cb18-88" data-line-number="88"><span class="kw">class</span> HumanPlayer <span class="kw">extends</span> <span class="va">I</span>.<span class="at">Record</span>(<span class="op">{</span><span class="dt">gameState</span><span class="op">:</span> <span class="kw">null</span><span class="op">}</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb18-89" data-line-number="89">  async <span class="at">getNextGameState</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb18-90" data-line-number="90">    <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`You are player </span><span class="sc">${</span> <span class="kw">this</span>.<span class="va">gameState</span>.<span class="at">nextPlayer</span> <span class="sc">}</span><span class="vs">. Game is below.`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb18-91" data-line-number="91">    <span class="kw">this</span>.<span class="va">gameState</span>.<span class="at">draw</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb18-92" data-line-number="92"></a>
<a class="sourceLine" id="cb18-93" data-line-number="93">    <span class="kw">const</span> nextGameStates <span class="op">=</span> <span class="kw">this</span>.<span class="va">gameState</span>.<span class="at">nextGameStates</span><span class="op">;</span></a>
<a class="sourceLine" id="cb18-94" data-line-number="94"></a>
<a class="sourceLine" id="cb18-95" data-line-number="95">    <span class="va">nextGameStates</span>.<span class="at">entrySeq</span>().<span class="at">forEach</span>(entry <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb18-96" data-line-number="96">      <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`No. </span><span class="sc">${</span> entry[<span class="dv">0</span>] <span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb18-97" data-line-number="97">      entry[<span class="dv">1</span>].<span class="at">draw</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb18-98" data-line-number="98">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb18-99" data-line-number="99"></a>
<a class="sourceLine" id="cb18-100" data-line-number="100">    <span class="cf">return</span> await <span class="kw">new</span> <span class="at">Promise</span>(resolve <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb18-101" data-line-number="101">      <span class="kw">const</span> readlineInterface <span class="op">=</span> <span class="va">readline</span>.<span class="at">createInterface</span>(<span class="op">{</span> <span class="dt">input</span><span class="op">:</span> <span class="va">process</span>.<span class="at">stdin</span><span class="op">,</span> <span class="dt">output</span><span class="op">:</span> <span class="va">process</span>.<span class="at">stdout</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb18-102" data-line-number="102"></a>
<a class="sourceLine" id="cb18-103" data-line-number="103">      <span class="va">readlineInterface</span>.<span class="at">question</span>(<span class="st">'Which do you select? '</span><span class="op">,</span> answer <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb18-104" data-line-number="104">        <span class="at">resolve</span>(<span class="va">nextGameStates</span>.<span class="at">get</span>(answer))<span class="op">;</span></a>
<a class="sourceLine" id="cb18-105" data-line-number="105">        <span class="va">readlineInterface</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb18-106" data-line-number="106">      <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb18-107" data-line-number="107">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb18-108" data-line-number="108">  <span class="op">}</span></a>
<a class="sourceLine" id="cb18-109" data-line-number="109"><span class="op">}</span></a>
<a class="sourceLine" id="cb18-110" data-line-number="110"></a>
<a class="sourceLine" id="cb18-111" data-line-number="111"><span class="co">// ゲームを実行します。GameStateが引数になって属性が不要になったので、関数にします。</span></a>
<a class="sourceLine" id="cb18-112" data-line-number="112"><span class="im">export</span> <span class="im">default</span> async <span class="kw">function</span> <span class="at">tictactoe</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb18-113" data-line-number="113">  <span class="co">// 再帰でループします。引数は、ゲームの状態とプレイヤーの集合です。</span></a>
<a class="sourceLine" id="cb18-114" data-line-number="114">  (async <span class="kw">function</span> <span class="at">_</span>(gameState<span class="op">,</span> players) <span class="op">{</span></a>
<a class="sourceLine" id="cb18-115" data-line-number="115">    <span class="co">// 勝者を表示します。</span></a>
<a class="sourceLine" id="cb18-116" data-line-number="116">    <span class="kw">const</span> winner <span class="op">=</span> <span class="va">gameState</span>.<span class="at">winner</span><span class="op">;</span></a>
<a class="sourceLine" id="cb18-117" data-line-number="117">    <span class="cf">if</span> (winner <span class="op">&gt;=</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb18-118" data-line-number="118">      <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Player </span><span class="sc">${</span> <span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="st">'-'</span><span class="op">,</span> <span class="st">'1'</span><span class="op">,</span> <span class="st">'2'</span>).<span class="at">get</span>(winner) <span class="sc">}</span><span class="vs"> win!`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb18-119" data-line-number="119">      <span class="va">gameState</span>.<span class="at">draw</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb18-120" data-line-number="120">      <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb18-121" data-line-number="121">    <span class="op">}</span></a>
<a class="sourceLine" id="cb18-122" data-line-number="122"></a>
<a class="sourceLine" id="cb18-123" data-line-number="123">    <span class="co">// 最初のプレイヤーを使用してgetNextGameState()した結果と残りのプレイヤーの集合を引数にして再帰します。</span></a>
<a class="sourceLine" id="cb18-124" data-line-number="124">    <span class="at">_</span>(await <span class="va">players</span>.<span class="at">first</span>().<span class="at">set</span>(<span class="st">'gameState'</span><span class="op">,</span> gameState).<span class="at">getNextGameState</span>()<span class="op">,</span> <span class="va">players</span>.<span class="at">rest</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb18-125" data-line-number="125">  <span class="op">}</span>)(</a>
<a class="sourceLine" id="cb18-126" data-line-number="126">    <span class="co">// ゲームの状態。</span></a>
<a class="sourceLine" id="cb18-127" data-line-number="127">    <span class="kw">new</span> <span class="at">GameState</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb18-128" data-line-number="128">    <span class="co">// 人間、コンピューター、人間、コンピューターと無限に続く集合。Immutable.jsは無限の集合を扱えてとても便利。</span></a>
<a class="sourceLine" id="cb18-129" data-line-number="129">    <span class="va">I</span>.<span class="at">Repeat</span>(<span class="va">I</span>.<span class="va">List</span>.<span class="at">of</span>(<span class="kw">new</span> <span class="at">HumanPlayer</span>()<span class="op">,</span> <span class="kw">new</span> <span class="at">ComputerPlayer</span>())).<span class="at">flatten</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb18-130" data-line-number="130">  )<span class="op">;</span></a>
<a class="sourceLine" id="cb18-131" data-line-number="131"><span class="op">}</span></a></code></pre></div>
<p>やったぜ！　完全にイミュータブルです。短くなったし、分かりやすくなったし。Immutable.jsすげぇ！<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a></p>
<p>というわけで、これで完成かな？</p>
<h2>関数の組み合わせで、楽をしましょう</h2>
<p>いいえ、まだ完成ではありません。先程紹介した<code>filter</code>や<code>map</code>、<code>reduce</code>は関数型プログラミング由来の機能なので、これらの機能を使うだけでも関数型プログラミングと言える気がしますし、プログラミングはとても容易になりますけど。</p>
<p>でも、関数を引数にするということには、もっと大きな可能性があるんです。この可能性を捨てちゃうのは、ちょっともったいないでしょう。</p>
<p>先程のコードを、もう一度眺めてみてください。ラムダ式の中は普通にコードを書いていますよね？　この部分も、関数を引数に取ったり関数を返したりする関数で楽できないでしょうか？</p>
<p>具体的にやります。<code>GameState.nextPlayer()</code>で考えましょう。</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb19-1" data-line-number="1">get <span class="at">nextPlayer</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb19-2" data-line-number="2">  <span class="cf">return</span> <span class="kw">this</span>.<span class="va">board</span>.<span class="at">filter</span>(cell <span class="op">=&gt;</span> cell <span class="op">==</span> <span class="dv">0</span>).<span class="at">size</span> <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">1</span> <span class="op">?</span> <span class="dv">1</span> : <span class="dv">2</span><span class="op">;</span></a>
<a class="sourceLine" id="cb19-3" data-line-number="3"><span class="op">}</span></a></code></pre></div>
<p>このラムダ式では値が<code>0</code>か確認しているのですけど、まずはこの部分を関数として定義してみましょう。</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="kw">function</span> <span class="at">equals</span>(a<span class="op">,</span> b) <span class="op">{</span></a>
<a class="sourceLine" id="cb20-2" data-line-number="2">  <span class="cf">return</span> a <span class="op">==</span> b<span class="op">;</span></a>
<a class="sourceLine" id="cb20-3" data-line-number="3"><span class="op">}</span></a></code></pre></div>
<p>で、この関数を使うと、</p>
<pre class="javascripot"><code>get nextPlayer() {
  return this.board.filter(cell =&gt; equals(0, cell)).size % 2 == 1 ? 1 : 2;
}</code></pre>
<p>あれ？　ちっとも楽になりません。引数が2つだからダメなわけで、1つにしてみたら？</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="kw">function</span> <span class="at">equalsTo</span>(a) <span class="op">{</span></a>
<a class="sourceLine" id="cb22-2" data-line-number="2">  <span class="cf">return</span> (b) <span class="op">=&gt;</span> <span class="at">equals</span>(a<span class="op">,</span> b)<span class="op">;</span></a>
<a class="sourceLine" id="cb22-3" data-line-number="3"><span class="op">}</span></a>
<a class="sourceLine" id="cb22-4" data-line-number="4"></a>
<a class="sourceLine" id="cb22-5" data-line-number="5">get <span class="at">nextPlayer</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb22-6" data-line-number="6">  <span class="cf">return</span> <span class="kw">this</span>.<span class="va">board</span>.<span class="at">filter</span>(<span class="at">equalsTo</span>(<span class="dv">0</span>)).<span class="at">size</span> <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">1</span> <span class="op">?</span> <span class="dv">1</span> : <span class="dv">2</span><span class="op">;</span></a>
<a class="sourceLine" id="cb22-7" data-line-number="7"><span class="op">}</span></a></code></pre></div>
<p>いわゆる、関数を返す関数ですね。関数を呼び出した戻り値も関数で、その戻り値の関数を呼び出すような感じです。</p>
<p>ともあれ、<code>nextPlayer()</code>の部分は、これで簡単になりました。でも、<code>equals</code>と<code>equalsTo</code>の2つの関数を作るのは馬鹿らしい。だから、引数の一部分だけを指定した関数を返す関数を考えてみます。</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="kw">function</span> <span class="at">partial</span>(f<span class="op">,</span> ...<span class="at">params</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb23-2" data-line-number="2">  <span class="cf">return</span> (...<span class="at">moreParams</span>) <span class="op">=&gt;</span> <span class="at">f</span>(...<span class="at">params</span><span class="op">,</span> ...<span class="at">moreParams</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb23-3" data-line-number="3"><span class="op">}</span></a>
<a class="sourceLine" id="cb23-4" data-line-number="4"></a>
<a class="sourceLine" id="cb23-5" data-line-number="5">get <span class="at">nextPlayer</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb23-6" data-line-number="6">  <span class="cf">return</span> <span class="kw">this</span>.<span class="va">board</span>.<span class="at">filter</span>(<span class="at">partial</span>(equals<span class="op">,</span> <span class="dv">0</span>)).<span class="at">size</span> <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">1</span> <span class="op">?</span> <span class="dv">1</span> : <span class="dv">2</span><span class="op">;</span></a>
<a class="sourceLine" id="cb23-7" data-line-number="7"><span class="op">}</span></a></code></pre></div>
<p>これなら、<code>equals()</code>を書くだけで済みますな。でも、私は怠け者なので、<code>partial</code>を呼び出すのすら面倒くさい……。</p>
<p>というわけで、以下ではどうでしょうか？</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb24-1" data-line-number="1"><span class="kw">function</span> <span class="at">equals</span>(a<span class="op">,</span> b) <span class="op">{</span></a>
<a class="sourceLine" id="cb24-2" data-line-number="2">  <span class="cf">if</span> (<span class="kw">typeof</span> b <span class="op">==</span> <span class="st">'undefined'</span>) <span class="op">{</span>      <span class="co">// bが指定されなかった場合は、</span></a>
<a class="sourceLine" id="cb24-3" data-line-number="3">    <span class="cf">return</span> (b) <span class="op">=&gt;</span> <span class="at">curryEquals</span>(a<span class="op">,</span> b)<span class="op">;</span>  <span class="co">// 関数を返します。</span></a>
<a class="sourceLine" id="cb24-4" data-line-number="4">  <span class="op">}</span></a>
<a class="sourceLine" id="cb24-5" data-line-number="5"></a>
<a class="sourceLine" id="cb24-6" data-line-number="6">  <span class="cf">return</span> a <span class="op">==</span> b<span class="op">;</span>  <span class="co">// そうでなければ、普通に処理します。</span></a>
<a class="sourceLine" id="cb24-7" data-line-number="7"><span class="op">}</span></a>
<a class="sourceLine" id="cb24-8" data-line-number="8"></a>
<a class="sourceLine" id="cb24-9" data-line-number="9">get <span class="at">nextPlayer</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb24-10" data-line-number="10">  <span class="cf">return</span> <span class="kw">this</span>.<span class="va">board</span>.<span class="at">filter</span>(<span class="at">equals</span>(<span class="dv">0</span>)).<span class="at">size</span> <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">1</span> <span class="op">?</span> <span class="dv">1</span> : <span class="dv">2</span><span class="op">;</span></a>
<a class="sourceLine" id="cb24-11" data-line-number="11"><span class="op">}</span></a></code></pre></div>
<p>ECMAScriptは引数の数が合わない場合はエラーにならずに単純に無視されますから、引数<code>b</code>が指定されなかった場合は関数を返して、両方を指定した場合は処理結果を返します。このように、引数を1つ指定すると残りの引数をとる関数を返すような関数にすることを、カリー化と呼びます<a href="#fn5" class="footnote-ref" id="fnref5"><sup>5</sup></a>。</p>
<p>でも、毎回こんな面倒な形で関数を書くのはやってられませんよね？　だから、カリー化を全面的に採用した関数型プログラミング用のライブラリである<a href="http://ramdajs.com/">Ramda</a>を使用しましょう。</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="im">import</span> R <span class="im">from</span> <span class="st">'ramda'</span><span class="op">;</span></a>
<a class="sourceLine" id="cb25-2" data-line-number="2"></a>
<a class="sourceLine" id="cb25-3" data-line-number="3">get <span class="at">nextPlayer</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb25-4" data-line-number="4">  <span class="co">// R.equals(a, b)の1つ目の引数だけ指定して、残りの1つを受け取る関数にします。</span></a>
<a class="sourceLine" id="cb25-5" data-line-number="5">  <span class="cf">return</span> <span class="kw">this</span>.<span class="va">board</span>.<span class="at">filter</span>(<span class="va">R</span>.<span class="at">equals</span>(<span class="dv">0</span>)).<span class="at">size</span> <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">1</span> <span class="op">?</span> <span class="dv">1</span> : <span class="dv">2</span><span class="op">;</span></a>
<a class="sourceLine" id="cb25-6" data-line-number="6"><span class="op">}</span></a></code></pre></div>
<p>うん、これでスッキリしました。でも、たとえば、</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="kw">const</span> winner <span class="op">=</span> winningLines</a>
<a class="sourceLine" id="cb26-2" data-line-number="2">  .<span class="at">map</span>(line <span class="op">=&gt;</span> <span class="va">line</span>.<span class="at">map</span>(index <span class="op">=&gt;</span> <span class="kw">this</span>.<span class="va">board</span>.<span class="at">get</span>(index)))</a>
<a class="sourceLine" id="cb26-3" data-line-number="3">  <span class="co">// セルの値の集合の残りが1つ目とすべて同じ場合、かつ、1つ目が0でない集合を取得します。</span></a>
<a class="sourceLine" id="cb26-4" data-line-number="4">  .<span class="at">filter</span>(cells <span class="op">=&gt;</span> <span class="va">cells</span>.<span class="at">rest</span>().<span class="at">every</span>(cell <span class="op">=&gt;</span> cell <span class="op">==</span> <span class="va">cells</span>.<span class="at">first</span>()) <span class="op">&amp;&amp;</span> <span class="va">cells</span>.<span class="at">first</span>() <span class="op">!=</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb26-5" data-line-number="5">  .<span class="at">map</span>(cells <span class="op">=&gt;</span> <span class="va">cells</span>.<span class="at">first</span>())</a>
<a class="sourceLine" id="cb26-6" data-line-number="6">  .<span class="at">first</span>()<span class="op">;</span></a></code></pre></div>
<p>の<code>cells =&gt; ... &amp;&amp; cells.first() != 0</code>の部分、「1つ目が0でない」の部分は、カリー化だけじゃ対応できませんよね？　処理が「集合の1つ目の値を取得する」と「値が0であることを確認する」の2段階に分かれているわけですから。こんな場合は、関数合成と呼ばれるテクニックを使用しましょう。関数合成というのは、「f(g(x))」を「f∘g」と数学の書くアレです。コードにすると、こんな感じ。</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="kw">function</span> <span class="at">compose</span>(f<span class="op">,</span> g) <span class="op">{</span></a>
<a class="sourceLine" id="cb27-2" data-line-number="2">  <span class="cf">return</span> (x) <span class="op">=&gt;</span> <span class="at">f</span>(<span class="at">g</span>(x))<span class="op">;</span></a>
<a class="sourceLine" id="cb27-3" data-line-number="3"><span class="op">}</span></a>
<a class="sourceLine" id="cb27-4" data-line-number="4"></a>
<a class="sourceLine" id="cb27-5" data-line-number="5"><span class="va">console</span>.<span class="at">log</span>(<span class="at">compose</span>(<span class="va">R</span>.<span class="at">multiply</span>(<span class="dv">2</span>)<span class="op">,</span> <span class="va">R</span>.<span class="at">add</span>(<span class="dv">2</span>))(<span class="dv">1</span>))<span class="op">;</span>  <span class="co">// 6が表示されます。(1 + 2) * 2 = 6なので。後述するpipeなら、1 * 2 + 2で4が表示されます。</span></a></code></pre></div>
<p><code>compose()</code>を使えば、<code>cells.first() != 0</code>の部分は<code>compose(R.complement(R.equals(0)), R.head)</code>と書けます（Ramdaでは<code>first</code>ではなくて<code>head</code>。<code>complement()</code>は、真偽を逆転させた関数を返します。<code>complement()</code>すると<code>x == 0</code>が<code>!(x == 0)</code>になります）。あと、Ramdaには、<code>pipe()</code>という書いた順と実行順序が同じになる素敵バージョンの関数合成もあります。</p>
<p>というわけで、Ramdaを使用して<code>GameState.winner()</code>を書き直してみましょう。</p>
<pre class="javascripot"><code>// 関数合成！
const f = R.pipe(R.map(R.map(R.nth(R.__, gameState.board))),  // R.__は、この部分をとばして引数を設定するようにとの指示。
                 R.filter(R.both(R.pipe(R.aperture(2), R.all(R.apply(R.equals))),  // 隣り同士が全部同じ場合、
                                 R.pipe(R.head, R.complement(R.equals(0))))),      // かつ、最初の要素の値が0じゃない場合、
                 R.ifElse(R.complement(R.isEmpty),  // 結果が空でなければ
                          R.pipe(R.head, R.head),   // 最初の要素の最初の要素が勝者。
                          R.always(R.any(R.equals(0), board) ? -1 : 0)));  // 0があるならまだ試合終了じゃない。なければ引き分け。

// 呼び出し。
return f(winningLines);</code></pre>
<p>あれ？　<code>winningLines...first()</code>の部分だけじゃなくて、その後の<code>if</code>文や三項演算子の部分まで書いちゃった……。関数合成でプログラムを組むのがあまりに楽ちん<a href="#fn6" class="footnote-ref" id="fnref6"><sup>6</sup></a>だったもんで、勢い余っちゃいましたよ。</p>
<p>でも、関数合成と呼び出しと引数の設定を一度にできたら、もっと楽になるような気がします（ECMAScriptで提案されているパイプライン演算子（<code>|&gt;</code>）みたいな感じ）。Ramdaを使う場合は、以下の書き方で似た機能を実現できます（<code>R.always</code>は、どんな引数で呼ばれても指定した値を返す関数を返す関数です）。</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="va">R</span>.<span class="at">call</span>(<span class="va">R</span>.<span class="at">pipe</span>(<span class="va">R</span>.<span class="at">always</span>(引数)<span class="op">,</span></a>
<a class="sourceLine" id="cb29-2" data-line-number="2">              f1<span class="op">,</span></a>
<a class="sourceLine" id="cb29-3" data-line-number="3">              <span class="va">f2</span>...))<span class="op">;</span></a></code></pre></div>
<p>こんな長いコードを毎回書くのは面倒なので、以下のコードで関数化してしまいましょう。</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb30-1" data-line-number="1"><span class="kw">const</span> cpa <span class="op">=</span> (x<span class="op">,</span> ...<span class="at">fs</span>) <span class="op">=&gt;</span> <span class="va">R</span>.<span class="at">call</span>(<span class="va">R</span>.<span class="at">pipe</span>(<span class="va">R</span>.<span class="at">always</span>(x)<span class="op">,</span> ...<span class="at">fs</span>))<span class="op">;</span></a></code></pre></div>
<p>これを前提にして勝者を判定するメソッド全体を書いてみると、以下のようになりました。</p>
<pre class="javascripot"><code>get winner() {
  const winningLines = [[0, 3, 6], [1, 4, 7], [2, 5, 8],  // 縦
                        [0, 1, 2], [3, 4, 5], [6, 7, 8],  // 横
                        [0, 4, 8], [2, 4, 6]];            // 斜め

  return cpa(winningLines,
             R.map(R.map(R.nth(R.__, this.board))),
             R.filter(R.both(R.pipe(R.aperture(2), R.all(R.apply(R.equals))),
                             R.pipe(R.head, R.complement(R.equals(0))))),
             R.ifElse(R.complement(R.isEmpty),
                      R.pipe(R.head, R.head),
                      R.always(R.any(R.equals(0), board) ? -1 : 0)));
}</code></pre>
<p>最初は文字がいっぱいで分かりづらく感じるかもしれませんけど、コードを書いていれば何回も何回も<code>map</code>だとか<code>equals</code>だとか<code>complement</code>とかに出会うことになるので、すぐに慣れてパターンとして認識できるようになります。そうなると、もープログラミングがちょー楽ちんなのですよ、本当に。</p>
<p>そうそう、<code>R.pipe(R.aperture(2), R.all(R.apply(R.equals)))</code>のような、今後も使いそうな部分に名前をつけるという工夫をしてもよいですしね。</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb32-1" data-line-number="1"><span class="kw">const</span> allSame <span class="op">=</span> <span class="va">R</span>.<span class="at">pipe</span>(<span class="va">R</span>.<span class="at">aperture</span>(<span class="dv">2</span>)<span class="op">,</span> <span class="va">R</span>.<span class="at">all</span>(<span class="va">R</span>.<span class="at">apply</span>(<span class="va">R</span>.<span class="at">equals</span>)))<span class="op">;</span></a></code></pre></div>
<p>もう少し。たとえば<code>R.filter(R.equals(0))</code>というコードは、「値が0の要素だけ抽出する」わけで、これだけで何をするのかだけが明確に分かります。外から見た仕様である外部仕様を、簡潔に明確に十分に記述しているわけです（内部仕様の「どのようにやるか」は、コードの中ですら書く必要がないんですな、今は）。でも、上のコードの<code>const winningLines = ...</code>の部分は、あまり良い仕様の記述には思えません。これが何なのかが分からなくて、コメントで補足しているのですから。</p>
<p>だから、この部分も仕様化しちゃいましょう。縦というのが何なのかといえば、上下に伸びるモノですよね？　今回は3×3のボードを1次元配列で表現しているので、以下のような感じでしょうか？</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb33-1" data-line-number="1"><span class="co">// -3すると上、+3すると下になります。</span></a>
<a class="sourceLine" id="cb33-2" data-line-number="2"><span class="kw">const</span> getVertical <span class="op">=</span> center <span class="op">=&gt;</span> [center <span class="op">-</span> <span class="dv">3</span><span class="op">,</span> center<span class="op">,</span> center <span class="op">+</span> <span class="dv">3</span>]<span class="op">;</span></a></code></pre></div>
<p>横はこんな感じ。</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb34-1" data-line-number="1"><span class="kw">const</span> getHorizontal <span class="op">=</span> center <span class="op">=&gt;</span> [center <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> center<span class="op">,</span> center <span class="op">+</span> <span class="dv">1</span>]<span class="op">;</span></a></code></pre></div>
<p><code>getVertical()</code>と<code>getHorizontal()</code>を組み合わせれば、「横のライン3つ」も表現できます。</p>
<pre class="javascripot"><code>const getHorizontals = R.pipe(getVertical, R.map(getHorizontal));  // 縦に伸ばしたそれぞれを中心にして、横に伸ばしたもの。</code></pre>
<p>斜めは複数あるので、こんな感じ。</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb36-1" data-line-number="1"><span class="co">// ベクトルの足し算がなかったので、定義しました。</span></a>
<a class="sourceLine" id="cb36-2" data-line-number="2"><span class="kw">const</span> addVector <span class="op">=</span> <span class="va">R</span>.<span class="at">curry</span>(<span class="va">R</span>.<span class="at">pipe</span>(<span class="va">R</span>.<span class="at">zip</span><span class="op">,</span> <span class="va">R</span>.<span class="at">map</span>(<span class="va">R</span>.<span class="at">apply</span>(<span class="va">R</span>.<span class="at">add</span>))))<span class="op">;</span></a>
<a class="sourceLine" id="cb36-3" data-line-number="3"></a>
<a class="sourceLine" id="cb36-4" data-line-number="4"><span class="co">// 縦に伸ばしたモノを、上を左に下を右にずらしたり、上を右に下を左にずらしたりしたもの。</span></a>
<a class="sourceLine" id="cb36-5" data-line-number="5"><span class="kw">const</span> getDiagonals <span class="op">=</span> center <span class="op">=&gt;</span> <span class="va">R</span>.<span class="at">map</span>(<span class="at">addVector</span>(<span class="at">getVertical</span>(center))<span class="op">,</span></a>
<a class="sourceLine" id="cb36-6" data-line-number="6">                                     [[<span class="op">-</span><span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="op">+</span><span class="dv">1</span>]<span class="op">,</span> [<span class="op">+</span><span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">-1</span>]])<span class="op">;</span></a></code></pre></div>
<p>というわけで、<code>winningLines</code>の定義は以下のようになりました。</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb37-1" data-line-number="1"><span class="kw">const</span> winningLines <span class="op">=</span> <span class="va">R</span>.<span class="at">call</span>(() <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb37-2" data-line-number="2">  <span class="kw">const</span> getHorizontal <span class="op">=</span> center <span class="op">=&gt;</span> [center <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> center<span class="op">,</span> center <span class="op">+</span> <span class="dv">1</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb37-3" data-line-number="3">  <span class="kw">const</span> getVertical   <span class="op">=</span> center <span class="op">=&gt;</span> [center <span class="op">-</span> <span class="dv">3</span><span class="op">,</span> center<span class="op">,</span> center <span class="op">+</span> <span class="dv">3</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb37-4" data-line-number="4">  <span class="kw">const</span> getDiagonals  <span class="op">=</span> center <span class="op">=&gt;</span> <span class="va">R</span>.<span class="at">map</span>(<span class="at">addVector</span>(<span class="at">getVertical</span>(center))<span class="op">,</span></a>
<a class="sourceLine" id="cb37-5" data-line-number="5">                                        [[<span class="op">-</span><span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="op">+</span><span class="dv">1</span>]<span class="op">,</span> [<span class="op">+</span><span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">-1</span>]])<span class="op">;</span></a>
<a class="sourceLine" id="cb37-6" data-line-number="6"></a>
<a class="sourceLine" id="cb37-7" data-line-number="7">  <span class="cf">return</span> <span class="at">cpa</span>(<span class="dv">4</span><span class="op">,</span>  <span class="co">// ゲーム板の中心。</span></a>
<a class="sourceLine" id="cb37-8" data-line-number="8">             <span class="va">R</span>.<span class="at">juxt</span>([<span class="va">R</span>.<span class="at">pipe</span>(<span class="va">R</span>.<span class="at">juxt</span>([<span class="va">R</span>.<span class="at">pipe</span>(getVertical<span class="op">,</span> <span class="va">R</span>.<span class="at">map</span>(getHorizontal))<span class="op">,</span></a>
<a class="sourceLine" id="cb37-9" data-line-number="9">                                    <span class="va">R</span>.<span class="at">pipe</span>(getHorizontal<span class="op">,</span> <span class="va">R</span>.<span class="at">map</span>(getVertical))])<span class="op">,</span></a>
<a class="sourceLine" id="cb37-10" data-line-number="10">                            <span class="va">R</span>.<span class="at">apply</span>(<span class="va">R</span>.<span class="at">concat</span>))<span class="op">,</span></a>
<a class="sourceLine" id="cb37-11" data-line-number="11">                     getDiagonals])<span class="op">,</span></a>
<a class="sourceLine" id="cb37-12" data-line-number="12">             <span class="va">R</span>.<span class="at">apply</span>(<span class="va">R</span>.<span class="at">concat</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb37-13" data-line-number="13"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>3×3のゲーム板に限定しているので汎用性がないへっぽこなコードなのですけど、いきなり数字の羅列を書くより仕様が明確になったと考えます。……正直、やり過ぎの気もするけどな。でも、関数型プログラミングをやっていると、「○○は××である」が不明確なところがあると落ち着かなくなるんですよ。</p>
<h2>汎用的なデータ構造でやりましょう</h2>
<p>これで最後。関数の話のあとは、データの話です。今回使用しているJavaScriptはとても面白い言語で、連想記憶をオブジェクトで表現します（ECMAScript 2015では連想記憶を表現するMapが追加されましたけど）。</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb38-1" data-line-number="1"><span class="kw">class</span> Computer <span class="op">{</span></a>
<a class="sourceLine" id="cb38-2" data-line-number="2">  <span class="at">constructor</span>(name<span class="op">,</span> memorySizeInGB) <span class="op">{</span></a>
<a class="sourceLine" id="cb38-3" data-line-number="3">    <span class="kw">this</span>.<span class="at">name</span> <span class="op">=</span> name<span class="op">;</span></a>
<a class="sourceLine" id="cb38-4" data-line-number="4">    <span class="kw">this</span>.<span class="at">memorySizeInGB</span> <span class="op">=</span> memorySizeInGB<span class="op">;</span></a>
<a class="sourceLine" id="cb38-5" data-line-number="5">  <span class="op">}</span></a>
<a class="sourceLine" id="cb38-6" data-line-number="6"><span class="op">};</span></a>
<a class="sourceLine" id="cb38-7" data-line-number="7"></a>
<a class="sourceLine" id="cb38-8" data-line-number="8"><span class="kw">class</span> Employee <span class="op">{</span></a>
<a class="sourceLine" id="cb38-9" data-line-number="9">  <span class="at">constructor</span>(name<span class="op">,</span> computers) <span class="op">{</span></a>
<a class="sourceLine" id="cb38-10" data-line-number="10">    <span class="kw">this</span>.<span class="at">name</span> <span class="op">=</span> name<span class="op">;</span></a>
<a class="sourceLine" id="cb38-11" data-line-number="11">    <span class="kw">this</span>.<span class="at">computers</span> <span class="op">=</span> computers<span class="op">;</span></a>
<a class="sourceLine" id="cb38-12" data-line-number="12">  <span class="op">}</span></a>
<a class="sourceLine" id="cb38-13" data-line-number="13"><span class="op">};</span></a>
<a class="sourceLine" id="cb38-14" data-line-number="14"></a>
<a class="sourceLine" id="cb38-15" data-line-number="15"><span class="kw">const</span> o <span class="op">=</span> [<span class="kw">new</span> <span class="at">Employee</span>(<span class="st">'A'</span><span class="op">,</span></a>
<a class="sourceLine" id="cb38-16" data-line-number="16">                        [<span class="kw">new</span> <span class="at">Computer</span>(<span class="st">'MacBook Pro'</span><span class="op">,</span>    <span class="dv">8</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb38-17" data-line-number="17">                         <span class="kw">new</span> <span class="at">Computer</span>(<span class="st">'ThinkPad T470s'</span><span class="op">,</span> <span class="dv">16</span>)])<span class="op">,</span></a>
<a class="sourceLine" id="cb38-18" data-line-number="18">           <span class="kw">new</span> <span class="at">Employee</span>(<span class="st">'B'</span><span class="op">,</span></a>
<a class="sourceLine" id="cb38-19" data-line-number="19">                        [<span class="kw">new</span> <span class="at">Computer</span>(<span class="st">'Surface Pro'</span><span class="op">,</span>    <span class="dv">4</span>)])]<span class="op">;</span></a>
<a class="sourceLine" id="cb38-20" data-line-number="20"></a>
<a class="sourceLine" id="cb38-21" data-line-number="21"><span class="kw">const</span> m <span class="op">=</span> [<span class="op">{</span><span class="dt">name</span><span class="op">:</span> <span class="st">'A'</span><span class="op">,</span></a>
<a class="sourceLine" id="cb38-22" data-line-number="22">            <span class="dt">computers</span><span class="op">:</span> [<span class="op">{</span><span class="dt">name</span><span class="op">:</span> <span class="st">'MacBook Pro'</span><span class="op">,</span></a>
<a class="sourceLine" id="cb38-23" data-line-number="23">                         <span class="dt">memorySizeInGB</span><span class="op">:</span> <span class="dv">8</span><span class="op">},</span></a>
<a class="sourceLine" id="cb38-24" data-line-number="24">                        <span class="op">{</span><span class="dt">name</span><span class="op">:</span> <span class="st">'THinkPad T470s'</span><span class="op">,</span></a>
<a class="sourceLine" id="cb38-25" data-line-number="25">                         <span class="dt">memorySizeInGB</span><span class="op">:</span> <span class="dv">16</span><span class="op">}</span>]<span class="op">},</span></a>
<a class="sourceLine" id="cb38-26" data-line-number="26">           <span class="op">{</span><span class="dt">name</span><span class="op">:</span> <span class="st">'B'</span><span class="op">,</span></a>
<a class="sourceLine" id="cb38-27" data-line-number="27">            <span class="dt">computers</span><span class="op">:</span> [<span class="op">{</span><span class="dt">name</span><span class="op">:</span> <span class="st">'Surface Pro'</span><span class="op">,</span></a>
<a class="sourceLine" id="cb38-28" data-line-number="28">                         <span class="dt">memorySizeInGB</span><span class="op">:</span> <span class="dv">4</span><span class="op">}</span>]<span class="op">}</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb38-29" data-line-number="29"></a>
<a class="sourceLine" id="cb38-30" data-line-number="30"><span class="co">// 連想記憶的にアクセスしてみます。</span></a>
<a class="sourceLine" id="cb38-31" data-line-number="31"><span class="va">console</span>.<span class="at">log</span>(o[<span class="dv">0</span>][<span class="st">'computers'</span>][<span class="dv">0</span>][<span class="st">'name'</span>])<span class="op">;</span>  <span class="co">// 「MacBook Pro」が表示されます。</span></a>
<a class="sourceLine" id="cb38-32" data-line-number="32"><span class="va">console</span>.<span class="at">log</span>(m[<span class="dv">0</span>][<span class="st">'computers'</span>][<span class="dv">0</span>][<span class="st">'name'</span>])<span class="op">;</span>  <span class="co">// 「MacBook Pro」が表示されます。</span></a>
<a class="sourceLine" id="cb38-33" data-line-number="33"></a>
<a class="sourceLine" id="cb38-34" data-line-number="34"><span class="co">// オブジェクト的にアクセスしてみます。</span></a>
<a class="sourceLine" id="cb38-35" data-line-number="35"><span class="va">console</span>.<span class="at">log</span>(o[<span class="dv">0</span>].<span class="at">computers</span>[<span class="dv">0</span>].<span class="at">name</span>)<span class="op">;</span>        <span class="co">// 「MacBook Pro」が表示されます。</span></a>
<a class="sourceLine" id="cb38-36" data-line-number="36"><span class="va">console</span>.<span class="at">log</span>(m[<span class="dv">0</span>].<span class="at">computers</span>[<span class="dv">0</span>].<span class="at">name</span>)<span class="op">;</span>        <span class="co">// 「MacBook Pro」が表示されます。</span></a></code></pre></div>
<p>で、前章で考えたように、組み合わせることを考えれば、オブジェクトのメソッドよりも関数を使用したほうが得。で、メソッドがないのだとしたらオブジェクトと連想記憶にはあまり差がなくて、だったらわざわざクラスを定義しなくてもいいんじゃね？　オブジェクトの属性がカプセル化されずに公開されることになりますけど、副作用が無いのだから問題は無いしね。なにより、汎用的な集合操作の関数群で処理を記述できる利便性は捨てがたい<a href="#fn7" class="footnote-ref" id="fnref7"><sup>7</sup></a>。</p>
<p>というわけで、関数型プログラマーは、言語が提供する型、リストやマップで多くの事柄を表現しちゃいます（Haskellの人には型を追加して数学的な特性を定義してカッチリやるのが好きな人もいるかもしれませんけど、私はHaskellerじゃなくてClojurianなので……）。だからたとえば、<code>x</code>と<code>y</code>を持つ<code>Point</code>クラスを作成する代わりに、要素数が2つのリストで座標を表現しちゃいます。<code>Point</code>のメソッドとして幾何計算の機能を追加していくのではなくて、汎用的な行列演算の関数群を作成して幾何計算をやるのです。</p>
<p>本稿でも、クラスを定義しないで、あと、先程から紹介してきたRamdaを利用して、三目並べを書き直してみました。以下が、その最終的なコード。</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb39-1" data-line-number="1"><span class="im">import</span> process  <span class="im">from</span> <span class="st">'process'</span><span class="op">;</span></a>
<a class="sourceLine" id="cb39-2" data-line-number="2"><span class="im">import</span> R        <span class="im">from</span> <span class="st">'ramda'</span><span class="op">;</span></a>
<a class="sourceLine" id="cb39-3" data-line-number="3"><span class="im">import</span> readline <span class="im">from</span> <span class="st">'readline'</span><span class="op">;</span></a>
<a class="sourceLine" id="cb39-4" data-line-number="4"></a>
<a class="sourceLine" id="cb39-5" data-line-number="5"><span class="co">// 引数や戻り値は、引数1 -&gt; 引数2 -&gt; 引数3 -&gt; ... -&gt; 戻り値で表現します。</span></a>
<a class="sourceLine" id="cb39-6" data-line-number="6"></a>
<a class="sourceLine" id="cb39-7" data-line-number="7"><span class="co">// ベクトルの足し算です。</span></a>
<a class="sourceLine" id="cb39-8" data-line-number="8"><span class="co">// [a] -&gt; [a] -&gt; [a]</span></a>
<a class="sourceLine" id="cb39-9" data-line-number="9"><span class="kw">const</span> addVector <span class="op">=</span> <span class="va">R</span>.<span class="at">curry</span>(<span class="va">R</span>.<span class="at">pipe</span>(<span class="va">R</span>.<span class="at">zip</span><span class="op">,</span> <span class="va">R</span>.<span class="at">map</span>(<span class="va">R</span>.<span class="at">apply</span>(<span class="va">R</span>.<span class="at">add</span>))))<span class="op">;</span></a>
<a class="sourceLine" id="cb39-10" data-line-number="10"></a>
<a class="sourceLine" id="cb39-11" data-line-number="11"><span class="co">// 集合の要素がすべて同じ場合はtrue、そうでなければfalseを返します。</span></a>
<a class="sourceLine" id="cb39-12" data-line-number="12"><span class="co">// [a] -&gt; Boolean</span></a>
<a class="sourceLine" id="cb39-13" data-line-number="13"><span class="kw">const</span> allSame <span class="op">=</span> <span class="va">R</span>.<span class="at">pipe</span>(<span class="va">R</span>.<span class="at">aperture</span>(<span class="dv">2</span>)<span class="op">,</span> <span class="va">R</span>.<span class="at">all</span>(<span class="va">R</span>.<span class="at">apply</span>(<span class="va">R</span>.<span class="at">equals</span>)))<span class="op">;</span></a>
<a class="sourceLine" id="cb39-14" data-line-number="14"></a>
<a class="sourceLine" id="cb39-15" data-line-number="15"><span class="co">// 集合を[要素, インデックス]の集合に変換します。</span></a>
<a class="sourceLine" id="cb39-16" data-line-number="16"><span class="co">// [a] -&gt; [[a, i]]</span></a>
<a class="sourceLine" id="cb39-17" data-line-number="17"><span class="kw">const</span> getIndexed <span class="op">=</span> <span class="va">R</span>.<span class="at">addIndex</span>(<span class="va">R</span>.<span class="at">map</span>)((a<span class="op">,</span> i) <span class="op">=&gt;</span> [a<span class="op">,</span> i])<span class="op">;</span></a>
<a class="sourceLine" id="cb39-18" data-line-number="18"></a>
<a class="sourceLine" id="cb39-19" data-line-number="19"><span class="co">// [要素, インデックス]の集合を、インデックスの集合に変換します、。</span></a>
<a class="sourceLine" id="cb39-20" data-line-number="20"><span class="co">// [[a, i]] -&gt; [i]</span></a>
<a class="sourceLine" id="cb39-21" data-line-number="21"><span class="kw">const</span> getIndice <span class="op">=</span> <span class="va">R</span>.<span class="at">map</span>(<span class="va">R</span>.<span class="at">nth</span>(<span class="dv">1</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb39-22" data-line-number="22"></a>
<a class="sourceLine" id="cb39-23" data-line-number="23"><span class="co">// fsで指定された関数群を順序を保って関数合成して、xを引数にして呼び出します。</span></a>
<a class="sourceLine" id="cb39-24" data-line-number="24"><span class="co">// R.call(R.pipe(R.always(x), ...fs)</span></a>
<a class="sourceLine" id="cb39-25" data-line-number="25"><span class="kw">const</span> cpa <span class="op">=</span> (x<span class="op">,</span> ...<span class="at">fs</span>) <span class="op">=&gt;</span> <span class="va">R</span>.<span class="at">call</span>(<span class="va">R</span>.<span class="at">pipe</span>(<span class="va">R</span>.<span class="at">always</span>(x)<span class="op">,</span> ...<span class="at">fs</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb39-26" data-line-number="26"></a>
<a class="sourceLine" id="cb39-27" data-line-number="27"><span class="co">// 縦横斜めの、3つ取れば勝ちになる直線のセルのインデックス。</span></a>
<a class="sourceLine" id="cb39-28" data-line-number="28"><span class="kw">const</span> winningLines <span class="op">=</span> <span class="va">R</span>.<span class="at">call</span>(() <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb39-29" data-line-number="29">  <span class="kw">const</span> getHorizontal <span class="op">=</span> center <span class="op">=&gt;</span> [center <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> center<span class="op">,</span> center <span class="op">+</span> <span class="dv">1</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb39-30" data-line-number="30">  <span class="kw">const</span> getVertical   <span class="op">=</span> center <span class="op">=&gt;</span> [center <span class="op">-</span> <span class="dv">3</span><span class="op">,</span> center<span class="op">,</span> center <span class="op">+</span> <span class="dv">3</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb39-31" data-line-number="31">  <span class="kw">const</span> getDiagonals  <span class="op">=</span> center <span class="op">=&gt;</span> <span class="va">R</span>.<span class="at">map</span>(<span class="at">addVector</span>(<span class="at">getVertical</span>(center))<span class="op">,</span> [[<span class="op">-</span><span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="op">+</span><span class="dv">1</span>]<span class="op">,</span> [<span class="op">+</span><span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">-1</span>]])<span class="op">;</span></a>
<a class="sourceLine" id="cb39-32" data-line-number="32"></a>
<a class="sourceLine" id="cb39-33" data-line-number="33">  <span class="cf">return</span> <span class="at">cpa</span>(<span class="dv">4</span><span class="op">,</span>  <span class="co">// ゲーム板の中心。</span></a>
<a class="sourceLine" id="cb39-34" data-line-number="34">             <span class="va">R</span>.<span class="at">juxt</span>([<span class="va">R</span>.<span class="at">pipe</span>(<span class="va">R</span>.<span class="at">juxt</span>([<span class="va">R</span>.<span class="at">pipe</span>(getVertical<span class="op">,</span> <span class="va">R</span>.<span class="at">map</span>(getHorizontal))<span class="op">,</span></a>
<a class="sourceLine" id="cb39-35" data-line-number="35">                                    <span class="va">R</span>.<span class="at">pipe</span>(getHorizontal<span class="op">,</span> <span class="va">R</span>.<span class="at">map</span>(getVertical))])<span class="op">,</span></a>
<a class="sourceLine" id="cb39-36" data-line-number="36">                            <span class="va">R</span>.<span class="at">apply</span>(<span class="va">R</span>.<span class="at">concat</span>))<span class="op">,</span></a>
<a class="sourceLine" id="cb39-37" data-line-number="37">                     getDiagonals])<span class="op">,</span></a>
<a class="sourceLine" id="cb39-38" data-line-number="38">             <span class="va">R</span>.<span class="at">apply</span>(<span class="va">R</span>.<span class="at">concat</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb39-39" data-line-number="39"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb39-40" data-line-number="40"></a>
<a class="sourceLine" id="cb39-41" data-line-number="41"><span class="co">// 勝者を返します。プレイヤー1の勝ちなら1、プレイヤー2の勝ちなら2、引き分けなら0、まだ勝負がついていないなら-1を返します。</span></a>
<a class="sourceLine" id="cb39-42" data-line-number="42"><span class="co">// ゲームのルールである勝利条件を定義します。</span></a>
<a class="sourceLine" id="cb39-43" data-line-number="43"><span class="kw">const</span> getWinner <span class="op">=</span> <span class="va">R</span>.<span class="at">memoize</span>(board <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb39-44" data-line-number="44">             <span class="co">// 勝利ラインの集合を、</span></a>
<a class="sourceLine" id="cb39-45" data-line-number="45">  <span class="cf">return</span> <span class="at">cpa</span>(winningLines<span class="op">,</span></a>
<a class="sourceLine" id="cb39-46" data-line-number="46">             <span class="co">// セルの値の集合の集合に変換して、</span></a>
<a class="sourceLine" id="cb39-47" data-line-number="47">             <span class="va">R</span>.<span class="at">map</span>(<span class="va">R</span>.<span class="at">map</span>(<span class="va">R</span>.<span class="at">nth</span>(<span class="va">R</span>.<span class="at">__</span><span class="op">,</span> board)))<span class="op">,</span></a>
<a class="sourceLine" id="cb39-48" data-line-number="48">             <span class="co">// すべて同じ値、かつ、先頭が0ではない集合だけ残して、</span></a>
<a class="sourceLine" id="cb39-49" data-line-number="49">             <span class="va">R</span>.<span class="at">filter</span>(<span class="va">R</span>.<span class="at">both</span>(allSame<span class="op">,</span> <span class="va">R</span>.<span class="at">pipe</span>(<span class="va">R</span>.<span class="at">head</span><span class="op">,</span> <span class="va">R</span>.<span class="at">complement</span>(<span class="va">R</span>.<span class="at">equals</span>(<span class="dv">0</span>)))))<span class="op">,</span></a>
<a class="sourceLine" id="cb39-50" data-line-number="50">             <span class="co">// もし結果が空でないなら、</span></a>
<a class="sourceLine" id="cb39-51" data-line-number="51">             <span class="va">R</span>.<span class="at">ifElse</span>(<span class="va">R</span>.<span class="at">complement</span>(<span class="va">R</span>.<span class="at">isEmpty</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb39-52" data-line-number="52">                      <span class="co">// 先頭の先頭が勝者。</span></a>
<a class="sourceLine" id="cb39-53" data-line-number="53">                      <span class="va">R</span>.<span class="at">pipe</span>(<span class="va">R</span>.<span class="at">head</span><span class="op">,</span> <span class="va">R</span>.<span class="at">head</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb39-54" data-line-number="54">                      <span class="co">// そうでなければ、0のセルがあるなら試合はまだ終了ではない。そうでなければ引き分け。</span></a>
<a class="sourceLine" id="cb39-55" data-line-number="55">                      <span class="va">R</span>.<span class="at">always</span>(<span class="va">R</span>.<span class="at">any</span>(<span class="va">R</span>.<span class="at">equals</span>(<span class="dv">0</span>)<span class="op">,</span> board) <span class="op">?</span> <span class="dv">-1</span> : <span class="dv">0</span>)))<span class="op">;</span></a>
<a class="sourceLine" id="cb39-56" data-line-number="56"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb39-57" data-line-number="57"></a>
<a class="sourceLine" id="cb39-58" data-line-number="58"><span class="co">// 次のプレイヤーを取得します。ゲームのルールである手番を定義します。</span></a>
<a class="sourceLine" id="cb39-59" data-line-number="59"><span class="kw">const</span> getNextPlayer <span class="op">=</span> <span class="va">R</span>.<span class="at">memoize</span>(board <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb39-60" data-line-number="60">  <span class="co">// 値が0のセルの数を2で割った余りが1ならプレイヤー1、そうでなければプレイヤー2。</span></a>
<a class="sourceLine" id="cb39-61" data-line-number="61">  <span class="cf">return</span> <span class="va">R</span>.<span class="at">length</span>(<span class="va">R</span>.<span class="at">filter</span>(<span class="va">R</span>.<span class="at">equals</span>(<span class="dv">0</span>)<span class="op">,</span> board)) <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">1</span> <span class="op">?</span> <span class="dv">1</span> : <span class="dv">2</span><span class="op">;</span></a>
<a class="sourceLine" id="cb39-62" data-line-number="62"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb39-63" data-line-number="63"></a>
<a class="sourceLine" id="cb39-64" data-line-number="64"><span class="co">// 次に遷移可能なゲーム版の状態を返します。プレイヤーが何をできるかというルールを、ここで実装します。</span></a>
<a class="sourceLine" id="cb39-65" data-line-number="65"><span class="kw">const</span> getNextBoards <span class="op">=</span> <span class="va">R</span>.<span class="at">memoize</span>(board <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb39-66" data-line-number="66">             <span class="co">// ゲーム板を、</span></a>
<a class="sourceLine" id="cb39-67" data-line-number="67">  <span class="cf">return</span> <span class="at">cpa</span>(board<span class="op">,</span></a>
<a class="sourceLine" id="cb39-68" data-line-number="68">             <span class="co">// インデックス化して、</span></a>
<a class="sourceLine" id="cb39-69" data-line-number="69">             getIndexed<span class="op">,</span></a>
<a class="sourceLine" id="cb39-70" data-line-number="70">             <span class="co">// 値が0（まだマルもバツも書き込まれていない）を取得して、</span></a>
<a class="sourceLine" id="cb39-71" data-line-number="71">             <span class="va">R</span>.<span class="at">filter</span>(<span class="va">R</span>.<span class="at">pipe</span>(<span class="va">R</span>.<span class="at">head</span><span class="op">,</span> <span class="va">R</span>.<span class="at">equals</span>(<span class="dv">0</span>)))<span class="op">,</span></a>
<a class="sourceLine" id="cb39-72" data-line-number="72">             <span class="co">// そのインデックスに変換して、</span></a>
<a class="sourceLine" id="cb39-73" data-line-number="73">             getIndice<span class="op">,</span></a>
<a class="sourceLine" id="cb39-74" data-line-number="74">             <span class="co">// ゲーム板の当該セルに次のプレイヤーを書き込んだモノの集合が次に遷移可能なゲーム板。</span></a>
<a class="sourceLine" id="cb39-75" data-line-number="75">             <span class="va">R</span>.<span class="at">map</span>(<span class="va">R</span>.<span class="at">update</span>(<span class="va">R</span>.<span class="at">__</span><span class="op">,</span> <span class="at">getNextPlayer</span>(board)<span class="op">,</span> board)))<span class="op">;</span></a>
<a class="sourceLine" id="cb39-76" data-line-number="76"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb39-77" data-line-number="77"></a>
<a class="sourceLine" id="cb39-78" data-line-number="78"><span class="co">// ゲーム板を描画します。</span></a>
<a class="sourceLine" id="cb39-79" data-line-number="79"><span class="kw">const</span> drawBoard <span class="op">=</span> board <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb39-80" data-line-number="80">                          <span class="co">// ゲーム板を、</span></a>
<a class="sourceLine" id="cb39-81" data-line-number="81">  <span class="kw">const</span> boardString <span class="op">=</span> <span class="at">cpa</span>(board<span class="op">,</span></a>
<a class="sourceLine" id="cb39-82" data-line-number="82">                          <span class="co">// 3つずつ（行単位）に分割して、</span></a>
<a class="sourceLine" id="cb39-83" data-line-number="83">                          <span class="va">R</span>.<span class="at">splitEvery</span>(<span class="dv">3</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb39-84" data-line-number="84">                          <span class="co">// 0は「-」、1は「O」、2は「X」に変換して、</span></a>
<a class="sourceLine" id="cb39-85" data-line-number="85">                          <span class="va">R</span>.<span class="at">map</span>(<span class="va">R</span>.<span class="at">pipe</span>(<span class="va">R</span>.<span class="at">map</span>(<span class="va">R</span>.<span class="at">nth</span>(<span class="va">R</span>.<span class="at">__</span><span class="op">,</span> [<span class="st">'-'</span><span class="op">,</span> <span class="st">'O'</span><span class="op">,</span> <span class="st">'X'</span>]))<span class="op">,</span></a>
<a class="sourceLine" id="cb39-86" data-line-number="86">                                       <span class="co">// 空白でつなげて文字列化したものを、</span></a>
<a class="sourceLine" id="cb39-87" data-line-number="87">                                       <span class="va">R</span>.<span class="at">join</span>(<span class="st">' '</span>)))<span class="op">,</span></a>
<a class="sourceLine" id="cb39-88" data-line-number="88">                          <span class="co">// さらに改行でつなげた文字列にします。</span></a>
<a class="sourceLine" id="cb39-89" data-line-number="89">                          <span class="va">R</span>.<span class="at">join</span>(<span class="st">'</span><span class="sc">\n</span><span class="st">'</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb39-90" data-line-number="90"></a>
<a class="sourceLine" id="cb39-91" data-line-number="91">  <span class="co">// 表示します。</span></a>
<a class="sourceLine" id="cb39-92" data-line-number="92">  <span class="va">console</span>.<span class="at">log</span>(boardString)<span class="op">;</span></a>
<a class="sourceLine" id="cb39-93" data-line-number="93"></a>
<a class="sourceLine" id="cb39-94" data-line-number="94">  <span class="co">// 連続して描画したときに区切りがないとわかりづらかったので、もう一度改行しておきます。</span></a>
<a class="sourceLine" id="cb39-95" data-line-number="95">  <span class="va">console</span>.<span class="at">log</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb39-96" data-line-number="96"><span class="op">};</span></a>
<a class="sourceLine" id="cb39-97" data-line-number="97"></a>
<a class="sourceLine" id="cb39-98" data-line-number="98"><span class="co">// コンピューターのプレイヤー。アルファ・ベータ法（正しくはネガ・アルファ法）で最適な手を打ちます。</span></a>
<a class="sourceLine" id="cb39-99" data-line-number="99"><span class="kw">const</span> getNextBoardByComputer <span class="op">=</span> async board <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb39-100" data-line-number="100">  <span class="co">// Wikipediaだと1つの関数になっていたのですけど、そのままだと書きづらかったので、これとgetScoreの2つに分けました。</span></a>
<a class="sourceLine" id="cb39-101" data-line-number="101">  <span class="co">// getNextScoreAndBoard()の戻り値は、[最良のスコア, そのスコアのゲーム板]です。</span></a>
<a class="sourceLine" id="cb39-102" data-line-number="102">  <span class="kw">const</span> getNextScoreAndBoard <span class="op">=</span> (board<span class="op">,</span> alpha<span class="op">,</span> beta) <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb39-103" data-line-number="103">    <span class="co">// 枝刈り。スコアがベータ値以上の場合は、探索しても意味がありません。</span></a>
<a class="sourceLine" id="cb39-104" data-line-number="104">    <span class="kw">const</span> prune <span class="op">=</span> <span class="va">R</span>.<span class="at">when</span>(<span class="va">R</span>.<span class="at">pipe</span>(<span class="va">R</span>.<span class="at">nth</span>(<span class="dv">0</span>)<span class="op">,</span> <span class="va">R</span>.<span class="at">gte</span>(<span class="va">R</span>.<span class="at">__</span><span class="op">,</span> beta))<span class="op">,</span></a>
<a class="sourceLine" id="cb39-105" data-line-number="105">                         <span class="co">// reducedしてreduceを打ち切ります。</span></a>
<a class="sourceLine" id="cb39-106" data-line-number="106">                         <span class="va">R</span>.<span class="at">reduced</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb39-107" data-line-number="107"></a>
<a class="sourceLine" id="cb39-108" data-line-number="108">    <span class="co">// 最も大きなスコアのゲーム板を探します。アルファ・ベータ法での枝刈りもします。</span></a>
<a class="sourceLine" id="cb39-109" data-line-number="109">    <span class="cf">return</span> <span class="va">R</span>.<span class="at">reduce</span>((acc<span class="op">,</span> nextBoard) <span class="op">=&gt;</span> <span class="at">prune</span>(<span class="va">R</span>.<span class="at">maxBy</span>(<span class="va">R</span>.<span class="at">head</span><span class="op">,</span> acc<span class="op">,</span></a>
<a class="sourceLine" id="cb39-110" data-line-number="110">                                                      [<span class="op">-</span><span class="at">getScore</span>(nextBoard<span class="op">,</span> <span class="op">-</span>beta<span class="op">,</span> <span class="op">-</span><span class="va">R</span>.<span class="at">head</span>(acc))<span class="op">,</span></a>
<a class="sourceLine" id="cb39-111" data-line-number="111">                                                       nextBoard]))<span class="op">,</span></a>
<a class="sourceLine" id="cb39-112" data-line-number="112">                    [alpha<span class="op">,</span> <span class="kw">null</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb39-113" data-line-number="113">                    <span class="at">getNextBoards</span>(board))<span class="op">;</span></a>
<a class="sourceLine" id="cb39-114" data-line-number="114">  <span class="op">};</span></a>
<a class="sourceLine" id="cb39-115" data-line-number="115"></a>
<a class="sourceLine" id="cb39-116" data-line-number="116">  <span class="co">// ゲーム状態のスコアを計算します。</span></a>
<a class="sourceLine" id="cb39-117" data-line-number="117">  <span class="kw">const</span> getScore <span class="op">=</span> (board<span class="op">,</span> alpha<span class="op">,</span> beta) <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb39-118" data-line-number="118">    <span class="co">// 勝負がついたときは、</span></a>
<a class="sourceLine" id="cb39-119" data-line-number="119">    <span class="kw">const</span> winner <span class="op">=</span> <span class="at">getWinner</span>(board)<span class="op">;</span></a>
<a class="sourceLine" id="cb39-120" data-line-number="120">    <span class="cf">if</span> (winner <span class="op">&gt;=</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb39-121" data-line-number="121">      <span class="co">// 引き分けなら0、勝ちなら1、負けなら-1をゲーム板のスコアとします。</span></a>
<a class="sourceLine" id="cb39-122" data-line-number="122">      <span class="cf">return</span> winner <span class="op">==</span> <span class="dv">0</span> <span class="op">?</span> <span class="dv">0</span> : (winner <span class="op">==</span> <span class="at">getNextPlayer</span>(board) <span class="op">?</span> <span class="dv">1</span> : <span class="dv">-1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb39-123" data-line-number="123">    <span class="op">}</span></a>
<a class="sourceLine" id="cb39-124" data-line-number="124"></a>
<a class="sourceLine" id="cb39-125" data-line-number="125">    <span class="co">// まだ勝負がついていない場合は、次に遷移可能なゲーム板のスコアがスコアとなります。</span></a>
<a class="sourceLine" id="cb39-126" data-line-number="126">    <span class="cf">return</span> <span class="va">R</span>.<span class="at">nth</span>(<span class="dv">0</span><span class="op">,</span> <span class="at">getNextScoreAndBoard</span>(board<span class="op">,</span> alpha<span class="op">,</span> beta))<span class="op">;</span></a>
<a class="sourceLine" id="cb39-127" data-line-number="127">  <span class="op">};</span></a>
<a class="sourceLine" id="cb39-128" data-line-number="128"></a>
<a class="sourceLine" id="cb39-129" data-line-number="129">  <span class="co">// 最も良い、次のゲーム板を選択します。</span></a>
<a class="sourceLine" id="cb39-130" data-line-number="130">  <span class="cf">return</span> <span class="va">R</span>.<span class="at">nth</span>(<span class="dv">1</span><span class="op">,</span> <span class="at">getNextScoreAndBoard</span>(board<span class="op">,</span> <span class="op">-</span><span class="kw">Infinity</span><span class="op">,</span> <span class="kw">Infinity</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb39-131" data-line-number="131"><span class="op">};</span></a>
<a class="sourceLine" id="cb39-132" data-line-number="132"></a>
<a class="sourceLine" id="cb39-133" data-line-number="133"><span class="co">// 人間のプレイヤー。遷移可能なゲーム状態を画面に表示して、その中から遷移先を選んでもらいます。</span></a>
<a class="sourceLine" id="cb39-134" data-line-number="134"><span class="kw">const</span> getNextBoardByHuman <span class="op">=</span> async board <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb39-135" data-line-number="135">  <span class="co">// 現在の状態を表示します。</span></a>
<a class="sourceLine" id="cb39-136" data-line-number="136">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`You are player </span><span class="sc">${</span> <span class="at">getNextPlayer</span>(board) <span class="sc">}</span><span class="vs">. Now board is below.`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb39-137" data-line-number="137">  <span class="at">drawBoard</span>(board)<span class="op">;</span></a>
<a class="sourceLine" id="cb39-138" data-line-number="138"></a>
<a class="sourceLine" id="cb39-139" data-line-number="139">  <span class="co">// 遷移可能なゲーム板の集合を取得します。</span></a>
<a class="sourceLine" id="cb39-140" data-line-number="140">  <span class="kw">const</span> nextBoards <span class="op">=</span> <span class="at">getNextBoards</span>(board)<span class="op">;</span></a>
<a class="sourceLine" id="cb39-141" data-line-number="141"></a>
<a class="sourceLine" id="cb39-142" data-line-number="142">  <span class="co">// 遷移可能なゲーム板をすべて表示します。</span></a>
<a class="sourceLine" id="cb39-143" data-line-number="143">  <span class="va">R</span>.<span class="at">addIndex</span>(<span class="va">R</span>.<span class="at">forEach</span>)((board<span class="op">,</span> i) <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb39-144" data-line-number="144">    <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`No. </span><span class="sc">${</span> i <span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb39-145" data-line-number="145">    <span class="at">drawBoard</span>(board)<span class="op">;</span></a>
<a class="sourceLine" id="cb39-146" data-line-number="146">  <span class="op">},</span> nextBoards)<span class="op">;</span></a>
<a class="sourceLine" id="cb39-147" data-line-number="147"></a>
<a class="sourceLine" id="cb39-148" data-line-number="148">  <span class="co">// プレイヤーにゲーム状態を選択してもらいます。エラー・チェックは無視で……。</span></a>
<a class="sourceLine" id="cb39-149" data-line-number="149">  <span class="cf">return</span> await <span class="kw">new</span> <span class="at">Promise</span>(resolve <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb39-150" data-line-number="150">    <span class="kw">const</span> readlineInterface <span class="op">=</span> <span class="va">readline</span>.<span class="at">createInterface</span>(<span class="op">{</span> <span class="dt">input</span><span class="op">:</span> <span class="va">process</span>.<span class="at">stdin</span><span class="op">,</span> <span class="dt">output</span><span class="op">:</span> <span class="va">process</span>.<span class="at">stdout</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb39-151" data-line-number="151"></a>
<a class="sourceLine" id="cb39-152" data-line-number="152">    <span class="va">readlineInterface</span>.<span class="at">question</span>(<span class="st">'Which do you select? '</span><span class="op">,</span> answer <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb39-153" data-line-number="153">      <span class="at">resolve</span>(<span class="va">R</span>.<span class="at">nth</span>(answer<span class="op">,</span> nextBoards))<span class="op">;</span></a>
<a class="sourceLine" id="cb39-154" data-line-number="154">      <span class="va">readlineInterface</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb39-155" data-line-number="155">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb39-156" data-line-number="156">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb39-157" data-line-number="157"><span class="op">};</span></a>
<a class="sourceLine" id="cb39-158" data-line-number="158"></a>
<a class="sourceLine" id="cb39-159" data-line-number="159"><span class="co">// ゲームを実行します。</span></a>
<a class="sourceLine" id="cb39-160" data-line-number="160"><span class="im">export</span> <span class="im">default</span> async <span class="kw">function</span> <span class="at">tictactoe</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb39-161" data-line-number="161">  <span class="co">// Ramdaは無限集合を表現できないので、ECMSScript 2015のジェネレーターを使用します。</span></a>
<a class="sourceLine" id="cb39-162" data-line-number="162">  <span class="kw">const</span> getNextBoardFunctionIterator <span class="op">=</span> <span class="kw">function</span><span class="op">*</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb39-163" data-line-number="163">    <span class="cf">while</span> (<span class="kw">true</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb39-164" data-line-number="164">      <span class="kw">yield</span> getNextBoardByHuman<span class="op">;</span></a>
<a class="sourceLine" id="cb39-165" data-line-number="165">      <span class="kw">yield</span> getNextBoardByComputer<span class="op">;</span></a>
<a class="sourceLine" id="cb39-166" data-line-number="166">    <span class="op">}</span></a>
<a class="sourceLine" id="cb39-167" data-line-number="167">  <span class="op">}</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb39-168" data-line-number="168"></a>
<a class="sourceLine" id="cb39-169" data-line-number="169">  <span class="co">// 再帰でループします。ゲーム板を引数に取ります。</span></a>
<a class="sourceLine" id="cb39-170" data-line-number="170">  (async <span class="kw">function</span> <span class="at">f</span>(board) <span class="op">{</span></a>
<a class="sourceLine" id="cb39-171" data-line-number="171">    <span class="kw">const</span> winner <span class="op">=</span> <span class="at">getWinner</span>(board)<span class="op">;</span></a>
<a class="sourceLine" id="cb39-172" data-line-number="172">    <span class="cf">if</span> (winner <span class="op">&gt;=</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb39-173" data-line-number="173">      <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Player </span><span class="sc">${</span> <span class="va">R</span>.<span class="at">nth</span>(winner<span class="op">,</span> [<span class="st">'-'</span><span class="op">,</span> <span class="st">'1'</span><span class="op">,</span> <span class="st">'2'</span>]) <span class="sc">}</span><span class="vs"> win!`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb39-174" data-line-number="174">      <span class="at">drawBoard</span>(board)<span class="op">;</span></a>
<a class="sourceLine" id="cb39-175" data-line-number="175">      <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb39-176" data-line-number="176">    <span class="op">}</span></a>
<a class="sourceLine" id="cb39-177" data-line-number="177"></a>
<a class="sourceLine" id="cb39-178" data-line-number="178">    <span class="co">// プレイヤーが選択したゲーム板を引数に、再帰します。</span></a>
<a class="sourceLine" id="cb39-179" data-line-number="179">    <span class="at">f</span>(await <span class="va">getNextBoardFunctionIterator</span>.<span class="at">next</span>().<span class="at">value</span>(board))<span class="op">;</span></a>
<a class="sourceLine" id="cb39-180" data-line-number="180">  <span class="op">}</span>)(<span class="va">R</span>.<span class="at">repeat</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">9</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb39-181" data-line-number="181"><span class="op">}</span></a></code></pre></div>
<p>Ramdaが無限リストやECMAScriptのイテレーターを扱えなかったので最後の<code>tictactoe()</code>がかなり不細工（イテレーターは<code>next()</code>で内部状態が変わるのでイミュータブルじゃないし）ですけど、それ以外の部分は、重複のない、（関数型プログラミングの関数名に慣れていれば）読みやすいコードになったのではないでしょうか？</p>
<h2>パフォーマンス？　良くはないです。でも、それほど悪くは無いです</h2>
<p>おまけとして、敢えて触れずに来たパフォーマンスの話題を。関数型プログラミングで作成したプログラムの実行速度は、ぶっちゃけ遅いです。オブジェクトを変更するとコピーが作られてしまうんですからね（最初から関数型として作成されたプログラミング言語なら、うまいこと差分管理されてコピーは作られなかったりするのですけど）。</p>
<p>ともあれ、試してみましょう。コンピューター対コンピューターで100試合繰り返すのにかかった時間を、私のMacBook Pro（2017 TouchBar<em>非</em>搭載モデル）で調べてみました。</p>
<ul>
<li>関数型プログラミング</li>
</ul>
<pre class="shell"><code>$ time npm start
real    0m31.906s
user    0m32.262s
sys     0m0.404s</code></pre>
<ul>
<li>オブジェクト指向プログラミング（集合操作はfor文）</li>
</ul>
<pre class="shell"><code>$ time npm start
real    0m22.737s
user    0m23.289s
sys     0m0.710s</code></pre>
<ul>
<li>オブジェクト指向プログラミング（集合操作はImmutable.js）</li>
</ul>
<pre class="shell"><code>$ time npm start
real    1m55.251s
user    2m57.125s
sys     0m5.720s</code></pre>
<p>関数型プログラミングの実行速度って、良くはないけど悪すぎるわけではない感じ<a href="#fn8" class="footnote-ref" id="fnref8"><sup>8</sup></a>。<code>for</code>文の71%くらいの速度でした（普通はもっと悪いです。今回は<code>for</code>文の場合でもイミュータブルを目指していますから、差が縮まりました）。</p>
<h3>メモ化が有効な場合も多いしね</h3>
<p>今回のコードではあまり有効ではなかった（アルファ・ベータ法による枝刈りが効きすぎたので目立たなかった）のですけど、実は今回のコードには関数型プログラミングらしい高速化テクニックを入れているんです。<code>getWinner</code>や<code>getNextPlayer</code>、<code>getNextBoards</code>のところに書いてある<code>R.memoize()</code>がそれ。</p>
<p>考えてみましょう。副作用がなければ、同じ関数を同じ引数で呼び出した場合の戻り値は必ず同じになります。過去に計算した結果を覚えておけば、再度計算しなくても済むわけ。これがメモ化と呼ばれるテクニックで、<code>R.memoize()</code>は、このメモ化を実現してくれる（引数と結果の対応表をメモリ内に作成して、関数を実行する代わりにその表の値を自動で返してくれる関数を作成する）関数なんです。</p>
<p>あとね、そもそもね、同じゲーム板での最適手は毎回同じなわけで、だったら先程のベンチマークみたいに複数回ゲームが実行されると分かっているなら、<code>getNextBoardByComputer()</code>を<code>R.memoize()</code>しちゃえばよい<a href="#fn9" class="footnote-ref" id="fnref9"><sup>9</sup></a>。というわけで、<code>getNextBoardByComputer()</code>を<code>R.memoize()</code>した場合の試合数100の実行時間はこちら。</p>
<pre class="shell"><code>$ time npm start
real    0m1.042s
user    0m1.301s
sys     0m0.103s</code></pre>
<p>おお、<code>for</code>文の「にせんぱーせんと」の実行速度になりました。これなら問題ないですよね？　もし問題があっても、試合回数を増やすことでいくらでも数字を大きくできますし。</p>
<h2>関数型もいいけど、オブジェクト指向もね</h2>
<p>もう1つおまけを。実は最初は、オブジェクト指向の得意分野であるシミュレーションをお題にしようと考えていたんですよ。で、オブジェクト指向言語の元祖であるSimulaのWikipediaのページに載っていた試着室シミュレーションを、JavaScriptを使ってオブジェクト指向で組んだんです。そしてそのコードを関数型に書き換えようとしたらもー全然うまくいかなかったので途中で投げ出して三目並べにしたというわけ。「オブジェクトが相互にメッセージ・パッシングすることで状態が変わっていく」みたいな場合、オブジェクト指向は無敵な気がします。</p>
<p>でも、私が関数型プログラミングの能力を引き出せていないだけの気もするし……。どなたか、以下のコードを関数型プログラミングで書き直していただけないでしょうか？</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb44-1" data-line-number="1"><span class="im">import</span> util <span class="im">from</span> <span class="st">'util'</span><span class="op">;</span></a>
<a class="sourceLine" id="cb44-2" data-line-number="2"></a>
<a class="sourceLine" id="cb44-3" data-line-number="3"><span class="co">// オブジェクト指向で作成した、試着室とお客様のシミュレーション。</span></a>
<a class="sourceLine" id="cb44-4" data-line-number="4"><span class="co">// 元ネタはhttps://ja.wikipedia.org/wiki/Simulaのシミュレーションの部分。</span></a>
<a class="sourceLine" id="cb44-5" data-line-number="5"></a>
<a class="sourceLine" id="cb44-6" data-line-number="6"><span class="co">// ボックス・ミューラー法でひたすら正規乱数を生成するジェネレーター。</span></a>
<a class="sourceLine" id="cb44-7" data-line-number="7"><span class="kw">const</span> normalRandomGenerator <span class="op">=</span> <span class="kw">function</span><span class="op">*</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb44-8" data-line-number="8">  <span class="cf">while</span> (<span class="kw">true</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb44-9" data-line-number="9">    <span class="kw">const</span> x <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> <span class="va">Math</span>.<span class="at">random</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb44-10" data-line-number="10">    <span class="kw">const</span> y <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> <span class="va">Math</span>.<span class="at">random</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb44-11" data-line-number="11"></a>
<a class="sourceLine" id="cb44-12" data-line-number="12">    <span class="kw">yield</span> <span class="va">Math</span>.<span class="at">sqrt</span>(<span class="op">-</span><span class="dv">2</span> <span class="op">*</span> <span class="va">Math</span>.<span class="at">log</span>(x)) <span class="op">*</span> <span class="va">Math</span>.<span class="at">cos</span>(<span class="dv">2</span> <span class="op">*</span> <span class="va">Math</span>.<span class="at">PI</span> <span class="op">*</span> y)<span class="op">;</span></a>
<a class="sourceLine" id="cb44-13" data-line-number="13">    <span class="kw">yield</span> <span class="va">Math</span>.<span class="at">sqrt</span>(<span class="op">-</span><span class="dv">2</span> <span class="op">*</span> <span class="va">Math</span>.<span class="at">log</span>(x)) <span class="op">*</span> <span class="va">Math</span>.<span class="at">sin</span>(<span class="dv">2</span> <span class="op">*</span> <span class="va">Math</span>.<span class="at">PI</span> <span class="op">*</span> y)<span class="op">;</span></a>
<a class="sourceLine" id="cb44-14" data-line-number="14">  <span class="op">}</span></a>
<a class="sourceLine" id="cb44-15" data-line-number="15"><span class="op">}</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb44-16" data-line-number="16"></a>
<a class="sourceLine" id="cb44-17" data-line-number="17"><span class="co">// 平均値と標準偏差、最小値、最大値を指定して、正規乱数を1つ生成します。</span></a>
<a class="sourceLine" id="cb44-18" data-line-number="18"><span class="kw">const</span> normalRandom <span class="op">=</span> (mean <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> std <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> min <span class="op">=</span> <span class="op">-</span><span class="kw">Infinity</span><span class="op">,</span> max <span class="op">=</span> <span class="kw">Infinity</span>) <span class="op">=&gt;</span> <span class="va">Math</span>.<span class="at">max</span>(<span class="va">Math</span>.<span class="at">min</span>(mean <span class="op">+</span> std <span class="op">*</span> <span class="va">normalRandomGenerator</span>.<span class="at">next</span>().<span class="at">value</span><span class="op">,</span> max)<span class="op">,</span> min)<span class="op">;</span></a>
<a class="sourceLine" id="cb44-19" data-line-number="19"></a>
<a class="sourceLine" id="cb44-20" data-line-number="20"><span class="co">// 引数で指定したミリ秒の間、コルーチンを止めます。</span></a>
<a class="sourceLine" id="cb44-21" data-line-number="21"><span class="kw">const</span> delay <span class="op">=</span> <span class="va">util</span>.<span class="at">promisify</span>(setTimeout)<span class="op">;</span></a>
<a class="sourceLine" id="cb44-22" data-line-number="22"></a>
<a class="sourceLine" id="cb44-23" data-line-number="23"><span class="co">// シミュレーションを実行します。</span></a>
<a class="sourceLine" id="cb44-24" data-line-number="24"><span class="im">export</span> <span class="im">default</span> <span class="kw">function</span> <span class="at">execute</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb44-25" data-line-number="25">  <span class="co">// report()でのレポートは開始時刻からの経過時間でするので、開始時刻を記録しておきます。</span></a>
<a class="sourceLine" id="cb44-26" data-line-number="26">  <span class="kw">const</span> startingTime <span class="op">=</span> <span class="va">Date</span>.<span class="at">now</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb44-27" data-line-number="27"></a>
<a class="sourceLine" id="cb44-28" data-line-number="28">  <span class="co">// 状況をレポートします。</span></a>
<a class="sourceLine" id="cb44-29" data-line-number="29">  <span class="kw">function</span> <span class="at">report</span>(message) <span class="op">{</span></a>
<a class="sourceLine" id="cb44-30" data-line-number="30">    <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`</span><span class="sc">${</span> ((<span class="va">Date</span>.<span class="at">now</span>() <span class="op">-</span> startingTime) / <span class="dv">1000</span>).<span class="at">toFixed</span>(<span class="dv">2</span>) <span class="sc">}</span><span class="vs">: </span><span class="sc">${</span> message <span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb44-31" data-line-number="31">  <span class="op">}</span></a>
<a class="sourceLine" id="cb44-32" data-line-number="32"></a>
<a class="sourceLine" id="cb44-33" data-line-number="33">  <span class="co">// 試着室。</span></a>
<a class="sourceLine" id="cb44-34" data-line-number="34">  <span class="kw">class</span> FittingRoom <span class="op">{</span></a>
<a class="sourceLine" id="cb44-35" data-line-number="35">    <span class="co">// コンストラクター。</span></a>
<a class="sourceLine" id="cb44-36" data-line-number="36">    <span class="at">constructor</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb44-37" data-line-number="37">      <span class="kw">this</span>.<span class="at">hasUsed</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb44-38" data-line-number="38">      <span class="kw">this</span>.<span class="at">requestQueue</span> <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb44-39" data-line-number="39">    <span class="op">}</span></a>
<a class="sourceLine" id="cb44-40" data-line-number="40"></a>
<a class="sourceLine" id="cb44-41" data-line-number="41">    <span class="co">// 試着室に入ります。</span></a>
<a class="sourceLine" id="cb44-42" data-line-number="42">    async <span class="at">enter</span>() <span class="op">{</span>  <span class="co">// asyncは不要なのですけど、呼び出し側にawaitしてもらいやすいように付けておきます。</span></a>
<a class="sourceLine" id="cb44-43" data-line-number="43">      <span class="co">// 誰も使っていない場合は、</span></a>
<a class="sourceLine" id="cb44-44" data-line-number="44">      <span class="cf">if</span> (<span class="op">!</span><span class="kw">this</span>.<span class="at">hasUsed</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb44-45" data-line-number="45">        <span class="co">// 使用中の札をかけて、</span></a>
<a class="sourceLine" id="cb44-46" data-line-number="46">        <span class="kw">this</span>.<span class="at">hasUsed</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></a>
<a class="sourceLine" id="cb44-47" data-line-number="47">        <span class="co">// すぐに入ります。</span></a>
<a class="sourceLine" id="cb44-48" data-line-number="48">        <span class="cf">return</span> <span class="va">Promise</span>.<span class="at">resolve</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb44-49" data-line-number="49">      <span class="op">}</span></a>
<a class="sourceLine" id="cb44-50" data-line-number="50"></a>
<a class="sourceLine" id="cb44-51" data-line-number="51">      <span class="co">// 試着室が空くのを待つPromiseを作成して、そのresolveを待ち行列に入れておきます。</span></a>
<a class="sourceLine" id="cb44-52" data-line-number="52">      <span class="co">// このresolveは、leave()で呼び出されます。</span></a>
<a class="sourceLine" id="cb44-53" data-line-number="53">      <span class="cf">return</span> <span class="kw">new</span> <span class="at">Promise</span>(resolve <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb44-54" data-line-number="54">        <span class="kw">this</span>.<span class="va">requestQueue</span>.<span class="at">push</span>(resolve)<span class="op">;</span></a>
<a class="sourceLine" id="cb44-55" data-line-number="55">      <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb44-56" data-line-number="56">    <span class="op">}</span></a>
<a class="sourceLine" id="cb44-57" data-line-number="57"></a>
<a class="sourceLine" id="cb44-58" data-line-number="58">    <span class="co">// 試着室を出ます。</span></a>
<a class="sourceLine" id="cb44-59" data-line-number="59">    async <span class="at">leave</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb44-60" data-line-number="60">      <span class="co">// 誰も待っていないなら、</span></a>
<a class="sourceLine" id="cb44-61" data-line-number="61">      <span class="cf">if</span> (<span class="kw">this</span>.<span class="va">requestQueue</span>.<span class="at">length</span> <span class="op">==</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb44-62" data-line-number="62">        <span class="co">// 使用中の札をもとにもして、</span></a>
<a class="sourceLine" id="cb44-63" data-line-number="63">        <span class="kw">this</span>.<span class="at">hasUsed</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></a>
<a class="sourceLine" id="cb44-64" data-line-number="64">        <span class="co">// 終了します。</span></a>
<a class="sourceLine" id="cb44-65" data-line-number="65">        <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb44-66" data-line-number="66">      <span class="op">}</span></a>
<a class="sourceLine" id="cb44-67" data-line-number="67"></a>
<a class="sourceLine" id="cb44-68" data-line-number="68">      <span class="co">// 待ち行列の先頭のresolveを呼び出して、enter()の際に作成したPromiseを完了させます。</span></a>
<a class="sourceLine" id="cb44-69" data-line-number="69">      <span class="kw">this</span>.<span class="va">requestQueue</span>.<span class="at">shift</span>()()<span class="op">;</span></a>
<a class="sourceLine" id="cb44-70" data-line-number="70">    <span class="op">}</span></a>
<a class="sourceLine" id="cb44-71" data-line-number="71">  <span class="op">}</span></a>
<a class="sourceLine" id="cb44-72" data-line-number="72"></a>
<a class="sourceLine" id="cb44-73" data-line-number="73">  <span class="co">// 試着室を1つ設置します。</span></a>
<a class="sourceLine" id="cb44-74" data-line-number="74">  <span class="kw">const</span> fittingRoom <span class="op">=</span> <span class="kw">new</span> <span class="at">FittingRoom</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb44-75" data-line-number="75"></a>
<a class="sourceLine" id="cb44-76" data-line-number="76">  <span class="co">// お客様。</span></a>
<a class="sourceLine" id="cb44-77" data-line-number="77">  <span class="kw">class</span> Customer <span class="op">{</span></a>
<a class="sourceLine" id="cb44-78" data-line-number="78">    <span class="co">// コンストラクター。</span></a>
<a class="sourceLine" id="cb44-79" data-line-number="79">    <span class="at">constructor</span>(name) <span class="op">{</span></a>
<a class="sourceLine" id="cb44-80" data-line-number="80">      <span class="kw">this</span>.<span class="at">name</span> <span class="op">=</span> name<span class="op">;</span></a>
<a class="sourceLine" id="cb44-81" data-line-number="81">    <span class="op">}</span></a>
<a class="sourceLine" id="cb44-82" data-line-number="82"></a>
<a class="sourceLine" id="cb44-83" data-line-number="83">    <span class="co">// 商品を選びます。平均12分で標準偏差3分の正規乱数分かかるものとします。</span></a>
<a class="sourceLine" id="cb44-84" data-line-number="84">    async <span class="at">searchItem</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb44-85" data-line-number="85">      await <span class="at">delay</span>(<span class="at">normalRandom</span>(<span class="dv">12</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">24</span>) <span class="op">*</span> <span class="dv">1000</span>)<span class="op">;</span>  <span class="co">// シミュレーション内の時間は、1分＝1秒とします。</span></a>
<a class="sourceLine" id="cb44-86" data-line-number="86">    <span class="op">}</span></a>
<a class="sourceLine" id="cb44-87" data-line-number="87"></a>
<a class="sourceLine" id="cb44-88" data-line-number="88">    <span class="co">// 商品を試着します。平均3分で標準偏差1分の正規乱数分かかるものとします。</span></a>
<a class="sourceLine" id="cb44-89" data-line-number="89">    async <span class="at">useFittingRoom</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb44-90" data-line-number="90">      await <span class="at">delay</span>(<span class="at">normalRandom</span>( <span class="dv">3</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span>  <span class="dv">6</span>) <span class="op">*</span> <span class="dv">1000</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb44-91" data-line-number="91">    <span class="op">}</span></a>
<a class="sourceLine" id="cb44-92" data-line-number="92"></a>
<a class="sourceLine" id="cb44-93" data-line-number="93">    <span class="co">// 行動を開始します。</span></a>
<a class="sourceLine" id="cb44-94" data-line-number="94">    async <span class="at">start</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb44-95" data-line-number="95">      <span class="cf">while</span> (<span class="kw">true</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb44-96" data-line-number="96">        <span class="co">// 商品を選んで、</span></a>
<a class="sourceLine" id="cb44-97" data-line-number="97">        await <span class="kw">this</span>.<span class="at">searchItem</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb44-98" data-line-number="98"></a>
<a class="sourceLine" id="cb44-99" data-line-number="99">        <span class="co">// フィッティング・ルームに入ろうとします。他の人が使っているなら、空くまで待ちます。</span></a>
<a class="sourceLine" id="cb44-100" data-line-number="100">        <span class="at">report</span>(<span class="vs">`</span><span class="sc">${</span> <span class="kw">this</span>.<span class="at">name</span> <span class="sc">}</span><span class="vs"> is requesting the fitting room.`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb44-101" data-line-number="101">        await <span class="va">fittingRoom</span>.<span class="at">enter</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb44-102" data-line-number="102"></a>
<a class="sourceLine" id="cb44-103" data-line-number="103">        <span class="co">// 試着室に入れたら試着をして、</span></a>
<a class="sourceLine" id="cb44-104" data-line-number="104">        <span class="at">report</span>(<span class="vs">`</span><span class="sc">${</span> <span class="kw">this</span>.<span class="at">name</span> <span class="sc">}</span><span class="vs"> has entered the fitting room.`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb44-105" data-line-number="105">        await <span class="kw">this</span>.<span class="at">useFittingRoom</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb44-106" data-line-number="106"></a>
<a class="sourceLine" id="cb44-107" data-line-number="107">        <span class="co">// 試着室を出ます。</span></a>
<a class="sourceLine" id="cb44-108" data-line-number="108">        await <span class="va">fittingRoom</span>.<span class="at">leave</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb44-109" data-line-number="109">      <span class="op">}</span></a>
<a class="sourceLine" id="cb44-110" data-line-number="110">    <span class="op">}</span></a>
<a class="sourceLine" id="cb44-111" data-line-number="111">  <span class="op">}</span></a>
<a class="sourceLine" id="cb44-112" data-line-number="112"></a>
<a class="sourceLine" id="cb44-113" data-line-number="113">  <span class="co">// お客様は3人とします。</span></a>
<a class="sourceLine" id="cb44-114" data-line-number="114">  <span class="kw">new</span> <span class="at">Customer</span>(<span class="st">'Sam'</span>).<span class="at">start</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb44-115" data-line-number="115">  <span class="kw">new</span> <span class="at">Customer</span>(<span class="st">'Sally'</span>).<span class="at">start</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb44-116" data-line-number="116">  <span class="kw">new</span> <span class="at">Customer</span>(<span class="st">'Andy'</span>).<span class="at">start</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb44-117" data-line-number="117"><span class="op">}</span></a></code></pre></div>
<p>○○プログラミング最高！　○○プログラミング以外のやり方は○○プログラミングじゃないからダメ……という考え方は、やっぱりダメなのでしょうな。</p>
<section class="footnotes">
<hr />
<ol>
<li id="fn1"><p>ブラウザ上で実行している場合は、ですけどね。記述を省略可能な<code>window</code>オブジェクトの属性の宣言になっちゃうんですな。<code>window</code>オブジェクトが無いnode.jsでは、きちんとエラーになります。<a href="#fnref1" class="footnote-back">↩</a></p></li>
<li id="fn2"><p><code>Object.freeze()</code>でかなり解決できるのですけど、<code>set()</code>のような感じでオブジェクトを変更するのは難しいです。<a href="#fnref2" class="footnote-back">↩</a></p></li>
<li id="fn3"><p><code>['equals', 'language', 'ECMAScript']</code>みたいな引数を渡す感じです。大昔には、こんな使いづらいライブラリもあったんですよ、本当に。<a href="#fnref3" class="footnote-back">↩</a></p></li>
<li id="fn4"><p>まぁ、ECMAScriptだけでもほぼ同じ書き方ができるのですけど……。とはいえ、遅延評価があったりするので、Immutable.jsの集合操作が便利だというのは正しいはず。<a href="#fnref4" class="footnote-back">↩</a></p></li>
<li id="fn5"><p>カリー化の実現方法は言語やライブラリによって様々で、このコードのようなテキトーな方式ではないのでご安心を。<a href="#fnref5" class="footnote-back">↩</a></p></li>
<li id="fn6"><p>今考えると、<code>R.pipe(R.aperture(2), R.all(R.apply(R.equals)))</code>の部分はラムダ式でやった方が楽な気もしますけど……。<a href="#fnref6" class="footnote-back">↩</a></p></li>
<li id="fn7"><p>一般的な言語の話です。JavaScriptではオブジェクトに対しても汎用的な集合操作の関数を適用できるわけで、だから汎用データ構造を使う<em>積極的な</em>理由はあまりないんですよね。<a href="#fnref7" class="footnote-back">↩</a></p></li>
<li id="fn8"><p>Immutable.jsが妙に遅かったのは、すみません、今は理由が分かりません。たぶん、私のコードの書き方のせいだと思いますけど。<a href="#fnref8" class="footnote-back">↩</a></p></li>
<li id="fn9"><p>実は試合が1回だけの場合でも<code>getNextScoreAndBoard()</code>や<code>getScore()</code>に対するメモ化は有効です。でも、それをやると試合数を増やした場合に<code>getNextBoardByComputer()</code>をメモ化したのと同じ結果が出ちゃって、関数型プログラミングは速いという間違った結論になってしまうんですよ……。コンピュータ手番の1回目で、メモ化のオーバーヘッドで体感速度がかえって遅くなってしまいますしね。<a href="#fnref9" class="footnote-back">↩</a></p></li>
</ol>
</section>
</article>
</body>
</html>
